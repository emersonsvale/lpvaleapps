function ft(s){let t=s[0],e=s[1],i=s[2];return Math.sqrt(t*t+e*e+i*i)}function Xt(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s}function us(s,t,e,i){return s[0]=t,s[1]=e,s[2]=i,s}function re(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}function ne(s,t,e){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s}function fs(s,t,e){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s[2]=t[2]*e[2],s}function ds(s,t,e){return s[0]=t[0]/e[0],s[1]=t[1]/e[1],s[2]=t[2]/e[2],s}function At(s,t,e){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s}function ps(s,t){let e=t[0]-s[0],i=t[1]-s[1],r=t[2]-s[2];return Math.sqrt(e*e+i*i+r*r)}function gs(s,t){let e=t[0]-s[0],i=t[1]-s[1],r=t[2]-s[2];return e*e+i*i+r*r}function ae(s){let t=s[0],e=s[1],i=s[2];return t*t+e*e+i*i}function ms(s,t){return s[0]=-t[0],s[1]=-t[1],s[2]=-t[2],s}function xs(s,t){return s[0]=1/t[0],s[1]=1/t[1],s[2]=1/t[2],s}function qt(s,t){let e=t[0],i=t[1],r=t[2],n=e*e+i*i+r*r;return n>0&&(n=1/Math.sqrt(n)),s[0]=t[0]*n,s[1]=t[1]*n,s[2]=t[2]*n,s}function He(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]}function he(s,t,e){let i=t[0],r=t[1],n=t[2],a=e[0],o=e[1],h=e[2];return s[0]=r*h-n*o,s[1]=n*a-i*h,s[2]=i*o-r*a,s}function Ke(s,t,e,i){let r=t[0],n=t[1],a=t[2];return s[0]=r+i*(e[0]-r),s[1]=n+i*(e[1]-n),s[2]=a+i*(e[2]-a),s}function ys(s,t,e,i,r){const n=Math.exp(-i*r);let a=t[0],o=t[1],h=t[2];return s[0]=e[0]+(a-e[0])*n,s[1]=e[1]+(o-e[1])*n,s[2]=e[2]+(h-e[2])*n,s}function ws(s,t,e){let i=t[0],r=t[1],n=t[2],a=e[3]*i+e[7]*r+e[11]*n+e[15];return a=a||1,s[0]=(e[0]*i+e[4]*r+e[8]*n+e[12])/a,s[1]=(e[1]*i+e[5]*r+e[9]*n+e[13])/a,s[2]=(e[2]*i+e[6]*r+e[10]*n+e[14])/a,s}function Es(s,t,e){let i=t[0],r=t[1],n=t[2],a=e[3]*i+e[7]*r+e[11]*n+e[15];return a=a||1,s[0]=(e[0]*i+e[4]*r+e[8]*n)/a,s[1]=(e[1]*i+e[5]*r+e[9]*n)/a,s[2]=(e[2]*i+e[6]*r+e[10]*n)/a,s}function Ms(s,t,e){let i=t[0],r=t[1],n=t[2];return s[0]=i*e[0]+r*e[3]+n*e[6],s[1]=i*e[1]+r*e[4]+n*e[7],s[2]=i*e[2]+r*e[5]+n*e[8],s}function As(s,t,e){let i=t[0],r=t[1],n=t[2],a=e[0],o=e[1],h=e[2],l=e[3],c=o*n-h*r,u=h*i-a*n,d=a*r-o*i,f=o*d-h*u,g=h*c-a*d,x=a*u-o*c,p=l*2;return c*=p,u*=p,d*=p,f*=2,g*=2,x*=2,s[0]=i+c+f,s[1]=r+u+g,s[2]=n+d+x,s}const _s=(function(){const s=[0,0,0],t=[0,0,0];return function(e,i){Xt(s,e),Xt(t,i),qt(s,s),qt(t,t);let r=He(s,t);return r>1?0:r<-1?Math.PI:Math.acos(r)}})();function bs(s,t){return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}class _ extends Array{constructor(t=0,e=t,i=t){return super(t,e,i),this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set(t,e=t,i=t){return t.length?this.copy(t):(us(this,t,e,i),this)}copy(t){return Xt(this,t),this}add(t,e){return e?re(this,t,e):re(this,this,t),this}sub(t,e){return e?ne(this,t,e):ne(this,this,t),this}multiply(t){return t.length?fs(this,this,t):At(this,this,t),this}divide(t){return t.length?ds(this,this,t):At(this,this,1/t),this}inverse(t=this){return xs(this,t),this}len(){return ft(this)}distance(t){return t?ps(this,t):ft(this)}squaredLen(){return ae(this)}squaredDistance(t){return t?gs(this,t):ae(this)}negate(t=this){return ms(this,t),this}cross(t,e){return e?he(this,t,e):he(this,this,t),this}scale(t){return At(this,this,t),this}normalize(){return qt(this,this),this}dot(t){return He(this,t)}equals(t){return bs(this,t)}applyMatrix3(t){return Ms(this,this,t),this}applyMatrix4(t){return ws(this,this,t),this}scaleRotateMatrix4(t){return Es(this,this,t),this}applyQuaternion(t){return As(this,this,t),this}angle(t){return _s(this,t)}lerp(t,e){return Ke(this,this,t,e),this}smoothLerp(t,e,i){return ys(this,this,t,e,i),this}clone(){return new _(this[0],this[1],this[2])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}transformDirection(t){const e=this[0],i=this[1],r=this[2];return this[0]=t[0]*e+t[4]*i+t[8]*r,this[1]=t[1]*e+t[5]*i+t[9]*r,this[2]=t[2]*e+t[6]*i+t[10]*r,this.normalize()}}const oe=new _;let vs=1,Ts=1,le=!1;class ${constructor(t,e={}){t.canvas||console.error("gl not passed as first argument to Geometry"),this.gl=t,this.attributes=e,this.id=vs++,this.VAOs={},this.drawRange={start:0,count:0},this.instancedCount=0,this.gl.renderer.bindVertexArray(null),this.gl.renderer.currentGeometry=null,this.glState=this.gl.renderer.state;for(let i in e)this.addAttribute(i,e[i])}addAttribute(t,e){if(this.attributes[t]=e,e.id=Ts++,e.size=e.size||1,e.type=e.type||(e.data.constructor===Float32Array?this.gl.FLOAT:e.data.constructor===Uint16Array?this.gl.UNSIGNED_SHORT:this.gl.UNSIGNED_INT),e.target=t==="index"?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER,e.normalized=e.normalized||!1,e.stride=e.stride||0,e.offset=e.offset||0,e.count=e.count||(e.stride?e.data.byteLength/e.stride:e.data.length/e.size),e.divisor=e.instanced||0,e.needsUpdate=!1,e.usage=e.usage||this.gl.STATIC_DRAW,e.buffer||this.updateAttribute(e),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return console.warn("geometry has multiple instanced buffers of different length"),this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor);this.instancedCount=e.count*e.divisor}else t==="index"?this.drawRange.count=e.count:this.attributes.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}updateAttribute(t){const e=!t.buffer;e&&(t.buffer=this.gl.createBuffer()),this.glState.boundBuffer!==t.buffer&&(this.gl.bindBuffer(t.target,t.buffer),this.glState.boundBuffer=t.buffer),e?this.gl.bufferData(t.target,t.data,t.usage):this.gl.bufferSubData(t.target,0,t.data),t.needsUpdate=!1}setIndex(t){this.addAttribute("index",t)}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){this.VAOs[t.attributeOrder]=this.gl.renderer.createVertexArray(),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach((e,{name:i,type:r})=>{if(!this.attributes[i]){console.warn(`active attribute ${i} not being supplied`);return}const n=this.attributes[i];this.gl.bindBuffer(n.target,n.buffer),this.glState.boundBuffer=n.buffer;let a=1;r===35674&&(a=2),r===35675&&(a=3),r===35676&&(a=4);const o=n.size/a,h=a===1?0:a*a*4,l=a===1?0:a*4;for(let c=0;c<a;c++)this.gl.vertexAttribPointer(e+c,o,n.type,n.normalized,n.stride+h,n.offset+c*l),this.gl.enableVertexAttribArray(e+c),this.gl.renderer.vertexAttribDivisor(e+c,n.divisor)}),this.attributes.index&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.attributes.index.buffer)}draw({program:t,mode:e=this.gl.TRIANGLES}){this.gl.renderer.currentGeometry!==`${this.id}_${t.attributeOrder}`&&(this.VAOs[t.attributeOrder]||this.createVAO(t),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.gl.renderer.currentGeometry=`${this.id}_${t.attributeOrder}`),t.attributeLocations.forEach((r,{name:n})=>{const a=this.attributes[n];a.needsUpdate&&this.updateAttribute(a)});let i=2;this.attributes.index?.type===this.gl.UNSIGNED_INT&&(i=4),this.isInstanced?this.attributes.index?this.gl.renderer.drawElementsInstanced(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+this.drawRange.start*i,this.instancedCount):this.gl.renderer.drawArraysInstanced(e,this.drawRange.start,this.drawRange.count,this.instancedCount):this.attributes.index?this.gl.drawElements(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+this.drawRange.start*i):this.gl.drawArrays(e,this.drawRange.start,this.drawRange.count)}getPosition(){const t=this.attributes.position;if(t.data)return t;if(!le)return console.warn("No position buffer data found to compute bounds"),le=!0}computeBoundingBox(t){t||(t=this.getPosition());const e=t.data,i=t.size;this.bounds||(this.bounds={min:new _,max:new _,center:new _,scale:new _,radius:1/0});const r=this.bounds.min,n=this.bounds.max,a=this.bounds.center,o=this.bounds.scale;r.set(1/0),n.set(-1/0);for(let h=0,l=e.length;h<l;h+=i){const c=e[h],u=e[h+1],d=e[h+2];r.x=Math.min(c,r.x),r.y=Math.min(u,r.y),r.z=Math.min(d,r.z),n.x=Math.max(c,n.x),n.y=Math.max(u,n.y),n.z=Math.max(d,n.z)}o.sub(n,r),a.add(r,n).divide(2)}computeBoundingSphere(t){t||(t=this.getPosition());const e=t.data,i=t.size;this.bounds||this.computeBoundingBox(t);let r=0;for(let n=0,a=e.length;n<a;n+=i)oe.fromArray(e,n),r=Math.max(r,this.bounds.center.squaredDistance(oe));this.bounds.radius=Math.sqrt(r)}remove(){for(let t in this.VAOs)this.gl.renderer.deleteVertexArray(this.VAOs[t]),delete this.VAOs[t];for(let t in this.attributes)this.gl.deleteBuffer(this.attributes[t].buffer),delete this.attributes[t]}}let Rs=1;const ce={};class q{constructor(t,{vertex:e,fragment:i,uniforms:r={},transparent:n=!1,cullFace:a=t.BACK,frontFace:o=t.CCW,depthTest:h=!0,depthWrite:l=!0,depthFunc:c=t.LEQUAL}={}){t.canvas||console.error("gl not passed as first argument to Program"),this.gl=t,this.uniforms=r,this.id=Rs++,e||console.warn("vertex shader not supplied"),i||console.warn("fragment shader not supplied"),this.transparent=n,this.cullFace=a,this.frontFace=o,this.depthTest=h,this.depthWrite=l,this.depthFunc=c,this.blendFunc={},this.blendEquation={},this.stencilFunc={},this.stencilOp={},this.transparent&&!this.blendFunc.src&&(this.gl.renderer.premultipliedAlpha?this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)),this.vertexShader=t.createShader(t.VERTEX_SHADER),this.fragmentShader=t.createShader(t.FRAGMENT_SHADER),this.program=t.createProgram(),t.attachShader(this.program,this.vertexShader),t.attachShader(this.program,this.fragmentShader),this.setShaders({vertex:e,fragment:i})}setShaders({vertex:t,fragment:e}){if(t&&(this.gl.shaderSource(this.vertexShader,t),this.gl.compileShader(this.vertexShader),this.gl.getShaderInfoLog(this.vertexShader)!==""&&console.warn(`${this.gl.getShaderInfoLog(this.vertexShader)}
Vertex Shader
${ue(t)}`)),e&&(this.gl.shaderSource(this.fragmentShader,e),this.gl.compileShader(this.fragmentShader),this.gl.getShaderInfoLog(this.fragmentShader)!==""&&console.warn(`${this.gl.getShaderInfoLog(this.fragmentShader)}
Fragment Shader
${ue(e)}`)),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))return console.warn(this.gl.getProgramInfoLog(this.program));this.uniformLocations=new Map;let i=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_UNIFORMS);for(let a=0;a<i;a++){let o=this.gl.getActiveUniform(this.program,a);this.uniformLocations.set(o,this.gl.getUniformLocation(this.program,o.name));const h=o.name.match(/(\w+)/g);o.uniformName=h[0],o.nameComponents=h.slice(1)}this.attributeLocations=new Map;const r=[],n=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_ATTRIBUTES);for(let a=0;a<n;a++){const o=this.gl.getActiveAttrib(this.program,a),h=this.gl.getAttribLocation(this.program,o.name);h!==-1&&(r[h]=o.name,this.attributeLocations.set(o,h))}this.attributeOrder=r.join("")}setBlendFunc(t,e,i,r){this.blendFunc.src=t,this.blendFunc.dst=e,this.blendFunc.srcAlpha=i,this.blendFunc.dstAlpha=r,t&&(this.transparent=!0)}setBlendEquation(t,e){this.blendEquation.modeRGB=t,this.blendEquation.modeAlpha=e}setStencilFunc(t,e,i){this.stencilRef=e,this.stencilFunc.func=t,this.stencilFunc.ref=e,this.stencilFunc.mask=i}setStencilOp(t,e,i){this.stencilOp.stencilFail=t,this.stencilOp.depthFail=e,this.stencilOp.depthPass=i}applyState(){this.depthTest?this.gl.renderer.enable(this.gl.DEPTH_TEST):this.gl.renderer.disable(this.gl.DEPTH_TEST),this.cullFace?this.gl.renderer.enable(this.gl.CULL_FACE):this.gl.renderer.disable(this.gl.CULL_FACE),this.blendFunc.src?this.gl.renderer.enable(this.gl.BLEND):this.gl.renderer.disable(this.gl.BLEND),this.cullFace&&this.gl.renderer.setCullFace(this.cullFace),this.gl.renderer.setFrontFace(this.frontFace),this.gl.renderer.setDepthMask(this.depthWrite),this.gl.renderer.setDepthFunc(this.depthFunc),this.blendFunc.src&&this.gl.renderer.setBlendFunc(this.blendFunc.src,this.blendFunc.dst,this.blendFunc.srcAlpha,this.blendFunc.dstAlpha),this.gl.renderer.setBlendEquation(this.blendEquation.modeRGB,this.blendEquation.modeAlpha),this.stencilFunc.func||this.stencilOp.stencilFail?this.gl.renderer.enable(this.gl.STENCIL_TEST):this.gl.renderer.disable(this.gl.STENCIL_TEST),this.gl.renderer.setStencilFunc(this.stencilFunc.func,this.stencilFunc.ref,this.stencilFunc.mask),this.gl.renderer.setStencilOp(this.stencilOp.stencilFail,this.stencilOp.depthFail,this.stencilOp.depthPass)}use({flipFaces:t=!1}={}){let e=-1;this.gl.renderer.state.currentProgram===this.id||(this.gl.useProgram(this.program),this.gl.renderer.state.currentProgram=this.id),this.uniformLocations.forEach((r,n)=>{let a=this.uniforms[n.uniformName];for(const o of n.nameComponents){if(!a)break;if(o in a)a=a[o];else{if(Array.isArray(a.value))break;a=void 0;break}}if(!a)return fe(`Active uniform ${n.name} has not been supplied`);if(a&&a.value===void 0)return fe(`${n.name} uniform is missing a value parameter`);if(a.value.texture)return e=e+1,a.value.update(e),_t(this.gl,n.type,r,e);if(a.value.length&&a.value[0].texture){const o=[];return a.value.forEach(h=>{e=e+1,h.update(e),o.push(e)}),_t(this.gl,n.type,r,o)}_t(this.gl,n.type,r,a.value)}),this.applyState(),t&&this.gl.renderer.setFrontFace(this.frontFace===this.gl.CCW?this.gl.CW:this.gl.CCW)}remove(){this.gl.deleteProgram(this.program)}}function _t(s,t,e,i){i=i.length?Fs(i):i;const r=s.renderer.state.uniformLocations.get(e);if(i.length)if(r===void 0||r.length!==i.length)s.renderer.state.uniformLocations.set(e,i.slice(0));else{if(Ls(r,i))return;r.set?r.set(i):Ss(r,i),s.renderer.state.uniformLocations.set(e,r)}else{if(r===i)return;s.renderer.state.uniformLocations.set(e,i)}switch(t){case 5126:return i.length?s.uniform1fv(e,i):s.uniform1f(e,i);case 35664:return s.uniform2fv(e,i);case 35665:return s.uniform3fv(e,i);case 35666:return s.uniform4fv(e,i);case 35670:case 5124:case 35678:case 36306:case 35680:case 36289:return i.length?s.uniform1iv(e,i):s.uniform1i(e,i);case 35671:case 35667:return s.uniform2iv(e,i);case 35672:case 35668:return s.uniform3iv(e,i);case 35673:case 35669:return s.uniform4iv(e,i);case 35674:return s.uniformMatrix2fv(e,!1,i);case 35675:return s.uniformMatrix3fv(e,!1,i);case 35676:return s.uniformMatrix4fv(e,!1,i)}}function ue(s){let t=s.split(`
`);for(let e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join(`
`)}function Fs(s){const t=s.length,e=s[0].length;if(e===void 0)return s;const i=t*e;let r=ce[i];r||(ce[i]=r=new Float32Array(i));for(let n=0;n<t;n++)r.set(s[n],n*e);return r}function Ls(s,t){if(s.length!==t.length)return!1;for(let e=0,i=s.length;e<i;e++)if(s[e]!==t[e])return!1;return!0}function Ss(s,t){for(let e=0,i=s.length;e<i;e++)s[e]=t[e]}let bt=0;function fe(s){bt>100||(console.warn(s),bt++,bt>100&&console.warn("More than 100 program warnings - stopping logs."))}const vt=new _;let zs=1;class jr{constructor({canvas:t=document.createElement("canvas"),width:e=300,height:i=150,dpr:r=1,alpha:n=!1,depth:a=!0,stencil:o=!1,antialias:h=!1,premultipliedAlpha:l=!1,preserveDrawingBuffer:c=!1,powerPreference:u="default",autoClear:d=!0,webgl:f=2}={}){const g={alpha:n,depth:a,stencil:o,antialias:h,premultipliedAlpha:l,preserveDrawingBuffer:c,powerPreference:u};this.dpr=r,this.alpha=n,this.color=!0,this.depth=a,this.stencil=o,this.premultipliedAlpha=l,this.autoClear=d,this.id=zs++,f===2&&(this.gl=t.getContext("webgl2",g)),this.isWebgl2=!!this.gl,this.gl||(this.gl=t.getContext("webgl",g)),this.gl||console.error("unable to create webgl context"),this.gl.renderer=this,this.setSize(e,i),this.state={},this.state.blendFunc={src:this.gl.ONE,dst:this.gl.ZERO},this.state.blendEquation={modeRGB:this.gl.FUNC_ADD},this.state.cullFace=!1,this.state.frontFace=this.gl.CCW,this.state.depthMask=!0,this.state.depthFunc=this.gl.LEQUAL,this.state.premultiplyAlpha=!1,this.state.flipY=!1,this.state.unpackAlignment=4,this.state.framebuffer=null,this.state.viewport={x:0,y:0,width:null,height:null},this.state.textureUnits=[],this.state.activeTextureUnit=0,this.state.boundBuffer=null,this.state.uniformLocations=new Map,this.state.currentProgram=null,this.extensions={},this.isWebgl2?(this.getExtension("EXT_color_buffer_float"),this.getExtension("OES_texture_float_linear")):(this.getExtension("OES_texture_float"),this.getExtension("OES_texture_float_linear"),this.getExtension("OES_texture_half_float"),this.getExtension("OES_texture_half_float_linear"),this.getExtension("OES_element_index_uint"),this.getExtension("OES_standard_derivatives"),this.getExtension("EXT_sRGB"),this.getExtension("WEBGL_depth_texture"),this.getExtension("WEBGL_draw_buffers")),this.getExtension("WEBGL_compressed_texture_astc"),this.getExtension("EXT_texture_compression_bptc"),this.getExtension("WEBGL_compressed_texture_s3tc"),this.getExtension("WEBGL_compressed_texture_etc1"),this.getExtension("WEBGL_compressed_texture_pvrtc"),this.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),this.drawBuffers=this.getExtension("WEBGL_draw_buffers","drawBuffers","drawBuffersWEBGL"),this.parameters={},this.parameters.maxTextureUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.parameters.maxAnisotropy=this.getExtension("EXT_texture_filter_anisotropic")?this.gl.getParameter(this.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.dpr,this.gl.canvas.height=e*this.dpr,this.gl.canvas.style&&Object.assign(this.gl.canvas.style,{width:t+"px",height:e+"px"})}setViewport(t,e,i=0,r=0){this.state.viewport.width===t&&this.state.viewport.height===e||(this.state.viewport.width=t,this.state.viewport.height=e,this.state.viewport.x=i,this.state.viewport.y=r,this.gl.viewport(i,r,t,e))}setScissor(t,e,i=0,r=0){this.gl.scissor(i,r,t,e)}enable(t){this.state[t]!==!0&&(this.gl.enable(t),this.state[t]=!0)}disable(t){this.state[t]!==!1&&(this.gl.disable(t),this.state[t]=!1)}setBlendFunc(t,e,i,r){this.state.blendFunc.src===t&&this.state.blendFunc.dst===e&&this.state.blendFunc.srcAlpha===i&&this.state.blendFunc.dstAlpha===r||(this.state.blendFunc.src=t,this.state.blendFunc.dst=e,this.state.blendFunc.srcAlpha=i,this.state.blendFunc.dstAlpha=r,i!==void 0?this.gl.blendFuncSeparate(t,e,i,r):this.gl.blendFunc(t,e))}setBlendEquation(t,e){t=t||this.gl.FUNC_ADD,!(this.state.blendEquation.modeRGB===t&&this.state.blendEquation.modeAlpha===e)&&(this.state.blendEquation.modeRGB=t,this.state.blendEquation.modeAlpha=e,e!==void 0?this.gl.blendEquationSeparate(t,e):this.gl.blendEquation(t))}setCullFace(t){this.state.cullFace!==t&&(this.state.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.state.frontFace!==t&&(this.state.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.state.depthMask!==t&&(this.state.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.state.depthFunc!==t&&(this.state.depthFunc=t,this.gl.depthFunc(t))}setStencilMask(t){this.state.stencilMask!==t&&(this.state.stencilMask=t,this.gl.stencilMask(t))}setStencilFunc(t,e,i){this.state.stencilFunc===t&&this.state.stencilRef===e&&this.state.stencilFuncMask===i||(this.state.stencilFunc=t||this.gl.ALWAYS,this.state.stencilRef=e||0,this.state.stencilFuncMask=i||0,this.gl.stencilFunc(t||this.gl.ALWAYS,e||0,i||0))}setStencilOp(t,e,i){this.state.stencilFail===t&&this.state.stencilDepthFail===e&&this.state.stencilDepthPass===i||(this.state.stencilFail=t,this.state.stencilDepthFail=e,this.state.stencilDepthPass=i,this.gl.stencilOp(t,e,i))}activeTexture(t){this.state.activeTextureUnit!==t&&(this.state.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}bindFramebuffer({target:t=this.gl.FRAMEBUFFER,buffer:e=null}={}){this.state.framebuffer!==e&&(this.state.framebuffer=e,this.gl.bindFramebuffer(t,e))}getExtension(t,e,i){return e&&this.gl[e]?this.gl[e].bind(this.gl):(this.extensions[t]||(this.extensions[t]=this.gl.getExtension(t)),e?this.extensions[t]?this.extensions[t][i].bind(this.extensions[t]):null:this.extensions[t])}sortOpaque(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:t.zDepth!==e.zDepth?t.zDepth-e.zDepth:e.id-t.id}sortTransparent(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.zDepth!==e.zDepth?e.zDepth-t.zDepth:e.id-t.id}sortUI(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:e.id-t.id}getRenderList({scene:t,camera:e,frustumCull:i,sort:r}){let n=[];if(e&&i&&e.updateFrustum(),t.traverse(a=>{if(!a.visible)return!0;a.draw&&(i&&a.frustumCulled&&e&&!e.frustumIntersectsMesh(a)||n.push(a))}),r){const a=[],o=[],h=[];n.forEach(l=>{l.program.transparent?l.program.depthTest?o.push(l):h.push(l):a.push(l),l.zDepth=0,!(l.renderOrder!==0||!l.program.depthTest||!e)&&(l.worldMatrix.getTranslation(vt),vt.applyMatrix4(e.projectionViewMatrix),l.zDepth=vt.z)}),a.sort(this.sortOpaque),o.sort(this.sortTransparent),h.sort(this.sortUI),n=a.concat(o,h)}return n}render({scene:t,camera:e,target:i=null,update:r=!0,sort:n=!0,frustumCull:a=!0,clear:o}){i===null?(this.bindFramebuffer(),this.setViewport(this.width*this.dpr,this.height*this.dpr)):(this.bindFramebuffer(i),this.setViewport(i.width,i.height)),(o||this.autoClear&&o!==!1)&&(this.depth&&(!i||i.depth)&&(this.enable(this.gl.DEPTH_TEST),this.setDepthMask(!0)),(this.stencil||!i||i.stencil)&&(this.enable(this.gl.STENCIL_TEST),this.setStencilMask(255)),this.gl.clear((this.color?this.gl.COLOR_BUFFER_BIT:0)|(this.depth?this.gl.DEPTH_BUFFER_BIT:0)|(this.stencil?this.gl.STENCIL_BUFFER_BIT:0))),r&&t.updateMatrixWorld(),e&&e.updateMatrixWorld(),this.getRenderList({scene:t,camera:e,frustumCull:a,sort:n}).forEach(l=>{l.draw({camera:e})})}}function Qe(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s}function Ze(s,t,e,i,r){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function Ps(s,t,e){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s[3]=t[3]*e,s}function Je(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=e*e+i*i+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),s[0]=e*a,s[1]=i*a,s[2]=r*a,s[3]=n*a,s}function ts(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]}function Cs(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function Ns(s,t,e){e=e*.5;let i=Math.sin(e);return s[0]=i*t[0],s[1]=i*t[1],s[2]=i*t[2],s[3]=Math.cos(e),s}function de(s,t,e){let i=t[0],r=t[1],n=t[2],a=t[3],o=e[0],h=e[1],l=e[2],c=e[3];return s[0]=i*c+a*o+r*l-n*h,s[1]=r*c+a*h+n*o-i*l,s[2]=n*c+a*l+i*h-r*o,s[3]=a*c-i*o-r*h-n*l,s}function Is(s,t,e){e*=.5;let i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(e),h=Math.cos(e);return s[0]=i*h+a*o,s[1]=r*h+n*o,s[2]=n*h-r*o,s[3]=a*h-i*o,s}function Ds(s,t,e){e*=.5;let i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(e),h=Math.cos(e);return s[0]=i*h-n*o,s[1]=r*h+a*o,s[2]=n*h+i*o,s[3]=a*h-r*o,s}function Os(s,t,e){e*=.5;let i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(e),h=Math.cos(e);return s[0]=i*h+r*o,s[1]=r*h-i*o,s[2]=n*h+a*o,s[3]=a*h-n*o,s}function Bs(s,t,e,i){let r=t[0],n=t[1],a=t[2],o=t[3],h=e[0],l=e[1],c=e[2],u=e[3],d,f,g,x,p;return f=r*h+n*l+a*c+o*u,f<0&&(f=-f,h=-h,l=-l,c=-c,u=-u),1-f>1e-6?(d=Math.acos(f),g=Math.sin(d),x=Math.sin((1-i)*d)/g,p=Math.sin(i*d)/g):(x=1-i,p=i),s[0]=x*r+p*h,s[1]=x*n+p*l,s[2]=x*a+p*c,s[3]=x*o+p*u,s}function Us(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=e*e+i*i+r*r+n*n,o=a?1/a:0;return s[0]=-e*o,s[1]=-i*o,s[2]=-r*o,s[3]=n*o,s}function ks(s,t){return s[0]=-t[0],s[1]=-t[1],s[2]=-t[2],s[3]=t[3],s}function Vs(s,t){let e=t[0]+t[4]+t[8],i;if(e>0)i=Math.sqrt(e+1),s[3]=.5*i,i=.5/i,s[0]=(t[5]-t[7])*i,s[1]=(t[6]-t[2])*i,s[2]=(t[1]-t[3])*i;else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[r*3+r]&&(r=2);let n=(r+1)%3,a=(r+2)%3;i=Math.sqrt(t[r*3+r]-t[n*3+n]-t[a*3+a]+1),s[r]=.5*i,i=.5/i,s[3]=(t[n*3+a]-t[a*3+n])*i,s[n]=(t[n*3+r]+t[r*3+n])*i,s[a]=(t[a*3+r]+t[r*3+a])*i}return s}function Gs(s,t,e="YXZ"){let i=Math.sin(t[0]*.5),r=Math.cos(t[0]*.5),n=Math.sin(t[1]*.5),a=Math.cos(t[1]*.5),o=Math.sin(t[2]*.5),h=Math.cos(t[2]*.5);return e==="XYZ"?(s[0]=i*a*h+r*n*o,s[1]=r*n*h-i*a*o,s[2]=r*a*o+i*n*h,s[3]=r*a*h-i*n*o):e==="YXZ"?(s[0]=i*a*h+r*n*o,s[1]=r*n*h-i*a*o,s[2]=r*a*o-i*n*h,s[3]=r*a*h+i*n*o):e==="ZXY"?(s[0]=i*a*h-r*n*o,s[1]=r*n*h+i*a*o,s[2]=r*a*o+i*n*h,s[3]=r*a*h-i*n*o):e==="ZYX"?(s[0]=i*a*h-r*n*o,s[1]=r*n*h+i*a*o,s[2]=r*a*o-i*n*h,s[3]=r*a*h+i*n*o):e==="YZX"?(s[0]=i*a*h+r*n*o,s[1]=r*n*h+i*a*o,s[2]=r*a*o-i*n*h,s[3]=r*a*h-i*n*o):e==="XZY"&&(s[0]=i*a*h-r*n*o,s[1]=r*n*h-i*a*o,s[2]=r*a*o+i*n*h,s[3]=r*a*h+i*n*o),s}const $s=Qe,Ws=Ze,Xs=ts,qs=Je;class at extends Array{constructor(t=0,e=0,i=0,r=1){super(t,e,i,r),this.onChange=()=>{},this._target=this;const n=["0","1","2","3"];return new Proxy(this,{set(a,o){const h=Reflect.set(...arguments);return h&&n.includes(o)&&a.onChange(),h}})}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(t){this._target[0]=t,this.onChange()}set y(t){this._target[1]=t,this.onChange()}set z(t){this._target[2]=t,this.onChange()}set w(t){this._target[3]=t,this.onChange()}identity(){return Cs(this._target),this.onChange(),this}set(t,e,i,r){return t.length?this.copy(t):(Ws(this._target,t,e,i,r),this.onChange(),this)}rotateX(t){return Is(this._target,this._target,t),this.onChange(),this}rotateY(t){return Ds(this._target,this._target,t),this.onChange(),this}rotateZ(t){return Os(this._target,this._target,t),this.onChange(),this}inverse(t=this._target){return Us(this._target,t),this.onChange(),this}conjugate(t=this._target){return ks(this._target,t),this.onChange(),this}copy(t){return $s(this._target,t),this.onChange(),this}normalize(t=this._target){return qs(this._target,t),this.onChange(),this}multiply(t,e){return e?de(this._target,t,e):de(this._target,this._target,t),this.onChange(),this}dot(t){return Xs(this._target,t)}fromMatrix3(t){return Vs(this._target,t),this.onChange(),this}fromEuler(t,e){return Gs(this._target,t,t.order),e||this.onChange(),this}fromAxisAngle(t,e){return Ns(this._target,t,e),this.onChange(),this}slerp(t,e){return Bs(this._target,this._target,t,e),this.onChange(),this}fromArray(t,e=0){return this._target[0]=t[e],this._target[1]=t[e+1],this._target[2]=t[e+2],this._target[3]=t[e+3],this.onChange(),this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}const Ys=1e-6;function js(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],s}function Hs(s,t,e,i,r,n,a,o,h,l,c,u,d,f,g,x,p){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s[4]=n,s[5]=a,s[6]=o,s[7]=h,s[8]=l,s[9]=c,s[10]=u,s[11]=d,s[12]=f,s[13]=g,s[14]=x,s[15]=p,s}function Ks(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Qs(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],f=t[11],g=t[12],x=t[13],p=t[14],m=t[15],M=e*o-i*a,E=e*h-r*a,A=e*l-n*a,y=i*h-r*o,w=i*l-n*o,b=r*l-n*h,z=c*x-u*g,R=c*p-d*g,v=c*m-f*g,S=u*p-d*x,T=u*m-f*x,F=d*m-f*p,L=M*F-E*T+A*S+y*v-w*R+b*z;return L?(L=1/L,s[0]=(o*F-h*T+l*S)*L,s[1]=(r*T-i*F-n*S)*L,s[2]=(x*b-p*w+m*y)*L,s[3]=(d*w-u*b-f*y)*L,s[4]=(h*v-a*F-l*R)*L,s[5]=(e*F-r*v+n*R)*L,s[6]=(p*A-g*b-m*E)*L,s[7]=(c*b-d*A+f*E)*L,s[8]=(a*T-o*v+l*z)*L,s[9]=(i*v-e*T-n*z)*L,s[10]=(g*w-x*A+m*M)*L,s[11]=(u*A-c*w-f*M)*L,s[12]=(o*R-a*S-h*z)*L,s[13]=(e*S-i*R+r*z)*L,s[14]=(x*E-g*y-p*M)*L,s[15]=(c*y-u*E+d*M)*L,s):null}function es(s){let t=s[0],e=s[1],i=s[2],r=s[3],n=s[4],a=s[5],o=s[6],h=s[7],l=s[8],c=s[9],u=s[10],d=s[11],f=s[12],g=s[13],x=s[14],p=s[15],m=t*a-e*n,M=t*o-i*n,E=t*h-r*n,A=e*o-i*a,y=e*h-r*a,w=i*h-r*o,b=l*g-c*f,z=l*x-u*f,R=l*p-d*f,v=c*x-u*g,S=c*p-d*g,T=u*p-d*x;return m*T-M*S+E*v+A*R-y*z+w*b}function pe(s,t,e){let i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=t[9],f=t[10],g=t[11],x=t[12],p=t[13],m=t[14],M=t[15],E=e[0],A=e[1],y=e[2],w=e[3];return s[0]=E*i+A*o+y*u+w*x,s[1]=E*r+A*h+y*d+w*p,s[2]=E*n+A*l+y*f+w*m,s[3]=E*a+A*c+y*g+w*M,E=e[4],A=e[5],y=e[6],w=e[7],s[4]=E*i+A*o+y*u+w*x,s[5]=E*r+A*h+y*d+w*p,s[6]=E*n+A*l+y*f+w*m,s[7]=E*a+A*c+y*g+w*M,E=e[8],A=e[9],y=e[10],w=e[11],s[8]=E*i+A*o+y*u+w*x,s[9]=E*r+A*h+y*d+w*p,s[10]=E*n+A*l+y*f+w*m,s[11]=E*a+A*c+y*g+w*M,E=e[12],A=e[13],y=e[14],w=e[15],s[12]=E*i+A*o+y*u+w*x,s[13]=E*r+A*h+y*d+w*p,s[14]=E*n+A*l+y*f+w*m,s[15]=E*a+A*c+y*g+w*M,s}function Zs(s,t,e){let i=e[0],r=e[1],n=e[2],a,o,h,l,c,u,d,f,g,x,p,m;return t===s?(s[12]=t[0]*i+t[4]*r+t[8]*n+t[12],s[13]=t[1]*i+t[5]*r+t[9]*n+t[13],s[14]=t[2]*i+t[6]*r+t[10]*n+t[14],s[15]=t[3]*i+t[7]*r+t[11]*n+t[15]):(a=t[0],o=t[1],h=t[2],l=t[3],c=t[4],u=t[5],d=t[6],f=t[7],g=t[8],x=t[9],p=t[10],m=t[11],s[0]=a,s[1]=o,s[2]=h,s[3]=l,s[4]=c,s[5]=u,s[6]=d,s[7]=f,s[8]=g,s[9]=x,s[10]=p,s[11]=m,s[12]=a*i+c*r+g*n+t[12],s[13]=o*i+u*r+x*n+t[13],s[14]=h*i+d*r+p*n+t[14],s[15]=l*i+f*r+m*n+t[15]),s}function Js(s,t,e){let i=e[0],r=e[1],n=e[2];return s[0]=t[0]*i,s[1]=t[1]*i,s[2]=t[2]*i,s[3]=t[3]*i,s[4]=t[4]*r,s[5]=t[5]*r,s[6]=t[6]*r,s[7]=t[7]*r,s[8]=t[8]*n,s[9]=t[9]*n,s[10]=t[10]*n,s[11]=t[11]*n,s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],s}function ti(s,t,e,i){let r=i[0],n=i[1],a=i[2],o=Math.hypot(r,n,a),h,l,c,u,d,f,g,x,p,m,M,E,A,y,w,b,z,R,v,S,T,F,L,C;return Math.abs(o)<Ys?null:(o=1/o,r*=o,n*=o,a*=o,h=Math.sin(e),l=Math.cos(e),c=1-l,u=t[0],d=t[1],f=t[2],g=t[3],x=t[4],p=t[5],m=t[6],M=t[7],E=t[8],A=t[9],y=t[10],w=t[11],b=r*r*c+l,z=n*r*c+a*h,R=a*r*c-n*h,v=r*n*c-a*h,S=n*n*c+l,T=a*n*c+r*h,F=r*a*c+n*h,L=n*a*c-r*h,C=a*a*c+l,s[0]=u*b+x*z+E*R,s[1]=d*b+p*z+A*R,s[2]=f*b+m*z+y*R,s[3]=g*b+M*z+w*R,s[4]=u*v+x*S+E*T,s[5]=d*v+p*S+A*T,s[6]=f*v+m*S+y*T,s[7]=g*v+M*S+w*T,s[8]=u*F+x*L+E*C,s[9]=d*F+p*L+A*C,s[10]=f*F+m*L+y*C,s[11]=g*F+M*L+w*C,t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s)}function ei(s,t){return s[0]=t[12],s[1]=t[13],s[2]=t[14],s}function ss(s,t){let e=t[0],i=t[1],r=t[2],n=t[4],a=t[5],o=t[6],h=t[8],l=t[9],c=t[10];return s[0]=Math.hypot(e,i,r),s[1]=Math.hypot(n,a,o),s[2]=Math.hypot(h,l,c),s}function si(s){let t=s[0],e=s[1],i=s[2],r=s[4],n=s[5],a=s[6],o=s[8],h=s[9],l=s[10];const c=t*t+e*e+i*i,u=r*r+n*n+a*a,d=o*o+h*h+l*l;return Math.sqrt(Math.max(c,u,d))}const is=(function(){const s=[1,1,1];return function(t,e){let i=s;ss(i,e);let r=1/i[0],n=1/i[1],a=1/i[2],o=e[0]*r,h=e[1]*n,l=e[2]*a,c=e[4]*r,u=e[5]*n,d=e[6]*a,f=e[8]*r,g=e[9]*n,x=e[10]*a,p=o+u+x,m=0;return p>0?(m=Math.sqrt(p+1)*2,t[3]=.25*m,t[0]=(d-g)/m,t[1]=(f-l)/m,t[2]=(h-c)/m):o>u&&o>x?(m=Math.sqrt(1+o-u-x)*2,t[3]=(d-g)/m,t[0]=.25*m,t[1]=(h+c)/m,t[2]=(f+l)/m):u>x?(m=Math.sqrt(1+u-o-x)*2,t[3]=(f-l)/m,t[0]=(h+c)/m,t[1]=.25*m,t[2]=(d+g)/m):(m=Math.sqrt(1+x-o-u)*2,t[3]=(h-c)/m,t[0]=(f+l)/m,t[1]=(d+g)/m,t[2]=.25*m),t}})();function ii(s,t,e,i){let r=ft([s[0],s[1],s[2]]);const n=ft([s[4],s[5],s[6]]),a=ft([s[8],s[9],s[10]]);es(s)<0&&(r=-r),e[0]=s[12],e[1]=s[13],e[2]=s[14];const h=s.slice(),l=1/r,c=1/n,u=1/a;h[0]*=l,h[1]*=l,h[2]*=l,h[4]*=c,h[5]*=c,h[6]*=c,h[8]*=u,h[9]*=u,h[10]*=u,is(t,h),i[0]=r,i[1]=n,i[2]=a}function ri(s,t,e,i){const r=s,n=t[0],a=t[1],o=t[2],h=t[3],l=n+n,c=a+a,u=o+o,d=n*l,f=n*c,g=n*u,x=a*c,p=a*u,m=o*u,M=h*l,E=h*c,A=h*u,y=i[0],w=i[1],b=i[2];return r[0]=(1-(x+m))*y,r[1]=(f+A)*y,r[2]=(g-E)*y,r[3]=0,r[4]=(f-A)*w,r[5]=(1-(d+m))*w,r[6]=(p+M)*w,r[7]=0,r[8]=(g+E)*b,r[9]=(p-M)*b,r[10]=(1-(d+x))*b,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function ni(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=e+e,o=i+i,h=r+r,l=e*a,c=i*a,u=i*o,d=r*a,f=r*o,g=r*h,x=n*a,p=n*o,m=n*h;return s[0]=1-u-g,s[1]=c+m,s[2]=d-p,s[3]=0,s[4]=c-m,s[5]=1-l-g,s[6]=f+x,s[7]=0,s[8]=d+p,s[9]=f-x,s[10]=1-l-u,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function ai(s,t,e,i,r){let n=1/Math.tan(t/2),a=1/(i-r);return s[0]=n/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=n,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=(r+i)*a,s[11]=-1,s[12]=0,s[13]=0,s[14]=2*r*i*a,s[15]=0,s}function hi(s,t,e,i,r,n,a){let o=1/(t-e),h=1/(i-r),l=1/(n-a);return s[0]=-2*o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*h,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(t+e)*o,s[13]=(r+i)*h,s[14]=(a+n)*l,s[15]=1,s}function oi(s,t,e,i){let r=t[0],n=t[1],a=t[2],o=i[0],h=i[1],l=i[2],c=r-e[0],u=n-e[1],d=a-e[2],f=c*c+u*u+d*d;f===0?d=1:(f=1/Math.sqrt(f),c*=f,u*=f,d*=f);let g=h*d-l*u,x=l*c-o*d,p=o*u-h*c;return f=g*g+x*x+p*p,f===0&&(l?o+=1e-6:h?l+=1e-6:h+=1e-6,g=h*d-l*u,x=l*c-o*d,p=o*u-h*c,f=g*g+x*x+p*p),f=1/Math.sqrt(f),g*=f,x*=f,p*=f,s[0]=g,s[1]=x,s[2]=p,s[3]=0,s[4]=u*p-d*x,s[5]=d*g-c*p,s[6]=c*x-u*g,s[7]=0,s[8]=c,s[9]=u,s[10]=d,s[11]=0,s[12]=r,s[13]=n,s[14]=a,s[15]=1,s}function ge(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s[3]=t[3]+e[3],s[4]=t[4]+e[4],s[5]=t[5]+e[5],s[6]=t[6]+e[6],s[7]=t[7]+e[7],s[8]=t[8]+e[8],s[9]=t[9]+e[9],s[10]=t[10]+e[10],s[11]=t[11]+e[11],s[12]=t[12]+e[12],s[13]=t[13]+e[13],s[14]=t[14]+e[14],s[15]=t[15]+e[15],s}function me(s,t,e){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s[3]=t[3]-e[3],s[4]=t[4]-e[4],s[5]=t[5]-e[5],s[6]=t[6]-e[6],s[7]=t[7]-e[7],s[8]=t[8]-e[8],s[9]=t[9]-e[9],s[10]=t[10]-e[10],s[11]=t[11]-e[11],s[12]=t[12]-e[12],s[13]=t[13]-e[13],s[14]=t[14]-e[14],s[15]=t[15]-e[15],s}function li(s,t,e){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s[3]=t[3]*e,s[4]=t[4]*e,s[5]=t[5]*e,s[6]=t[6]*e,s[7]=t[7]*e,s[8]=t[8]*e,s[9]=t[9]*e,s[10]=t[10]*e,s[11]=t[11]*e,s[12]=t[12]*e,s[13]=t[13]*e,s[14]=t[14]*e,s[15]=t[15]*e,s}class V extends Array{constructor(t=1,e=0,i=0,r=0,n=0,a=1,o=0,h=0,l=0,c=0,u=1,d=0,f=0,g=0,x=0,p=1){return super(t,e,i,r,n,a,o,h,l,c,u,d,f,g,x,p),this}get x(){return this[12]}get y(){return this[13]}get z(){return this[14]}get w(){return this[15]}set x(t){this[12]=t}set y(t){this[13]=t}set z(t){this[14]=t}set w(t){this[15]=t}set(t,e,i,r,n,a,o,h,l,c,u,d,f,g,x,p){return t.length?this.copy(t):(Hs(this,t,e,i,r,n,a,o,h,l,c,u,d,f,g,x,p),this)}translate(t,e=this){return Zs(this,e,t),this}rotate(t,e,i=this){return ti(this,i,t,e),this}scale(t,e=this){return Js(this,e,typeof t=="number"?[t,t,t]:t),this}add(t,e){return e?ge(this,t,e):ge(this,this,t),this}sub(t,e){return e?me(this,t,e):me(this,this,t),this}multiply(t,e){return t.length?e?pe(this,t,e):pe(this,this,t):li(this,this,t),this}identity(){return Ks(this),this}copy(t){return js(this,t),this}fromPerspective({fov:t,aspect:e,near:i,far:r}={}){return ai(this,t,e,i,r),this}fromOrthogonal({left:t,right:e,bottom:i,top:r,near:n,far:a}){return hi(this,t,e,i,r,n,a),this}fromQuaternion(t){return ni(this,t),this}setPosition(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}inverse(t=this){return Qs(this,t),this}compose(t,e,i){return ri(this,t,e,i),this}decompose(t,e,i){return ii(this,t,e,i),this}getRotation(t){return is(t,this),this}getTranslation(t){return ei(t,this),this}getScaling(t){return ss(t,this),this}getMaxScaleOnAxis(){return si(this)}lookAt(t,e,i){return oi(this,t,e,i),this}determinant(){return es(this)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this[4]=t[e+4],this[5]=t[e+5],this[6]=t[e+6],this[7]=t[e+7],this[8]=t[e+8],this[9]=t[e+9],this[10]=t[e+10],this[11]=t[e+11],this[12]=t[e+12],this[13]=t[e+13],this[14]=t[e+14],this[15]=t[e+15],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t[e+4]=this[4],t[e+5]=this[5],t[e+6]=this[6],t[e+7]=this[7],t[e+8]=this[8],t[e+9]=this[9],t[e+10]=this[10],t[e+11]=this[11],t[e+12]=this[12],t[e+13]=this[13],t[e+14]=this[14],t[e+15]=this[15],t}}function ci(s,t,e="YXZ"){return e==="XYZ"?(s[1]=Math.asin(Math.min(Math.max(t[8],-1),1)),Math.abs(t[8])<.99999?(s[0]=Math.atan2(-t[9],t[10]),s[2]=Math.atan2(-t[4],t[0])):(s[0]=Math.atan2(t[6],t[5]),s[2]=0)):e==="YXZ"?(s[0]=Math.asin(-Math.min(Math.max(t[9],-1),1)),Math.abs(t[9])<.99999?(s[1]=Math.atan2(t[8],t[10]),s[2]=Math.atan2(t[1],t[5])):(s[1]=Math.atan2(-t[2],t[0]),s[2]=0)):e==="ZXY"?(s[0]=Math.asin(Math.min(Math.max(t[6],-1),1)),Math.abs(t[6])<.99999?(s[1]=Math.atan2(-t[2],t[10]),s[2]=Math.atan2(-t[4],t[5])):(s[1]=0,s[2]=Math.atan2(t[1],t[0]))):e==="ZYX"?(s[1]=Math.asin(-Math.min(Math.max(t[2],-1),1)),Math.abs(t[2])<.99999?(s[0]=Math.atan2(t[6],t[10]),s[2]=Math.atan2(t[1],t[0])):(s[0]=0,s[2]=Math.atan2(-t[4],t[5]))):e==="YZX"?(s[2]=Math.asin(Math.min(Math.max(t[1],-1),1)),Math.abs(t[1])<.99999?(s[0]=Math.atan2(-t[9],t[5]),s[1]=Math.atan2(-t[2],t[0])):(s[0]=0,s[1]=Math.atan2(t[8],t[10]))):e==="XZY"&&(s[2]=Math.asin(-Math.min(Math.max(t[4],-1),1)),Math.abs(t[4])<.99999?(s[0]=Math.atan2(t[6],t[5]),s[1]=Math.atan2(t[8],t[0])):(s[0]=Math.atan2(-t[9],t[10]),s[1]=0)),s}const xe=new V;class ui extends Array{constructor(t=0,e=t,i=t,r="YXZ"){super(t,e,i),this.order=r,this.onChange=()=>{},this._target=this;const n=["0","1","2"];return new Proxy(this,{set(a,o){const h=Reflect.set(...arguments);return h&&n.includes(o)&&a.onChange(),h}})}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this._target[0]=t,this.onChange()}set y(t){this._target[1]=t,this.onChange()}set z(t){this._target[2]=t,this.onChange()}set(t,e=t,i=t){return t.length?this.copy(t):(this._target[0]=t,this._target[1]=e,this._target[2]=i,this.onChange(),this)}copy(t){return this._target[0]=t[0],this._target[1]=t[1],this._target[2]=t[2],this.onChange(),this}reorder(t){return this._target.order=t,this.onChange(),this}fromRotationMatrix(t,e=this.order){return ci(this._target,t,e),this.onChange(),this}fromQuaternion(t,e=this.order,i){return xe.fromQuaternion(t),this._target.fromRotationMatrix(xe,e),i||this.onChange(),this}fromArray(t,e=0){return this._target[0]=t[e],this._target[1]=t[e+1],this._target[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}}class ot{constructor(){this.parent=null,this.children=[],this.visible=!0,this.matrix=new V,this.worldMatrix=new V,this.matrixAutoUpdate=!0,this.worldMatrixNeedsUpdate=!1,this.position=new _,this.quaternion=new at,this.scale=new _(1),this.rotation=new ui,this.up=new _(0,1,0),this.rotation._target.onChange=()=>this.quaternion.fromEuler(this.rotation,!0),this.quaternion._target.onChange=()=>this.rotation.fromQuaternion(this.quaternion,void 0,!0)}setParent(t,e=!0){this.parent&&t!==this.parent&&this.parent.removeChild(this,!1),this.parent=t,e&&t&&t.addChild(this,!1)}addChild(t,e=!0){~this.children.indexOf(t)||this.children.push(t),e&&t.setParent(this,!1)}removeChild(t,e=!0){~this.children.indexOf(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||t)&&(this.parent===null?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,t=!0);for(let e=0,i=this.children.length;e<i;e++)this.children[e].updateMatrixWorld(t)}updateMatrix(){this.matrix.compose(this.quaternion,this.position,this.scale),this.worldMatrixNeedsUpdate=!0}traverse(t){if(!t(this))for(let e=0,i=this.children.length;e<i;e++)this.children[e].traverse(t)}decompose(){this.matrix.decompose(this.quaternion._target,this.position,this.scale),this.rotation.fromQuaternion(this.quaternion)}lookAt(t,e=!1){e?this.matrix.lookAt(this.position,t,this.up):this.matrix.lookAt(t,this.position,this.up),this.matrix.getRotation(this.quaternion._target),this.rotation.fromQuaternion(this.quaternion)}}const fi=new V,di=new _,pi=new _;class rs extends ot{constructor(t,{near:e=.1,far:i=100,fov:r=45,aspect:n=1,left:a,right:o,bottom:h,top:l,zoom:c=1}={}){super(),Object.assign(this,{near:e,far:i,fov:r,aspect:n,left:a,right:o,bottom:h,top:l,zoom:c}),this.projectionMatrix=new V,this.viewMatrix=new V,this.projectionViewMatrix=new V,this.worldPosition=new _,this.type=a||o?"orthographic":"perspective",this.type==="orthographic"?this.orthographic():this.perspective()}perspective({near:t=this.near,far:e=this.far,fov:i=this.fov,aspect:r=this.aspect}={}){return Object.assign(this,{near:t,far:e,fov:i,aspect:r}),this.projectionMatrix.fromPerspective({fov:i*(Math.PI/180),aspect:r,near:t,far:e}),this.type="perspective",this}orthographic({near:t=this.near,far:e=this.far,left:i=this.left||-1,right:r=this.right||1,bottom:n=this.bottom||-1,top:a=this.top||1,zoom:o=this.zoom}={}){return Object.assign(this,{near:t,far:e,left:i,right:r,bottom:n,top:a,zoom:o}),i/=o,r/=o,n/=o,a/=o,this.projectionMatrix.fromOrthogonal({left:i,right:r,bottom:n,top:a,near:t,far:e}),this.type="orthographic",this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.inverse(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}updateProjectionMatrix(){return this.type==="perspective"?this.perspective():this.orthographic()}lookAt(t){return super.lookAt(t,!0),this}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(fi.inverse(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateFrustum(){this.frustum||(this.frustum=[new _,new _,new _,new _,new _,new _]);const t=this.projectionViewMatrix;this.frustum[0].set(t[3]-t[0],t[7]-t[4],t[11]-t[8]).constant=t[15]-t[12],this.frustum[1].set(t[3]+t[0],t[7]+t[4],t[11]+t[8]).constant=t[15]+t[12],this.frustum[2].set(t[3]+t[1],t[7]+t[5],t[11]+t[9]).constant=t[15]+t[13],this.frustum[3].set(t[3]-t[1],t[7]-t[5],t[11]-t[9]).constant=t[15]-t[13],this.frustum[4].set(t[3]-t[2],t[7]-t[6],t[11]-t[10]).constant=t[15]-t[14],this.frustum[5].set(t[3]+t[2],t[7]+t[6],t[11]+t[10]).constant=t[15]+t[14];for(let e=0;e<6;e++){const i=1/this.frustum[e].distance();this.frustum[e].multiply(i),this.frustum[e].constant*=i}}frustumIntersectsMesh(t,e=t.worldMatrix){if(!t.geometry.attributes.position||((!t.geometry.bounds||t.geometry.bounds.radius===1/0)&&t.geometry.computeBoundingSphere(),!t.geometry.bounds))return!0;const i=di;i.copy(t.geometry.bounds.center),i.applyMatrix4(e);const r=t.geometry.bounds.radius*e.getMaxScaleOnAxis();return this.frustumIntersectsSphere(i,r)}frustumIntersectsSphere(t,e){const i=pi;for(let r=0;r<6;r++){const n=this.frustum[r];if(i.copy(n).dot(t)+n.constant<-e)return!1}return!0}}function gi(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],s}function mi(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=e+e,o=i+i,h=r+r,l=e*a,c=i*a,u=i*o,d=r*a,f=r*o,g=r*h,x=n*a,p=n*o,m=n*h;return s[0]=1-u-g,s[3]=c-m,s[6]=d+p,s[1]=c+m,s[4]=1-l-g,s[7]=f-x,s[2]=d-p,s[5]=f+x,s[8]=1-l-u,s}function xi(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s}function yi(s,t,e,i,r,n,a,o,h,l){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s[4]=n,s[5]=a,s[6]=o,s[7]=h,s[8]=l,s}function wi(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s}function Ei(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=c*a-o*l,d=-c*n+o*h,f=l*n-a*h,g=e*u+i*d+r*f;return g?(g=1/g,s[0]=u*g,s[1]=(-c*i+r*l)*g,s[2]=(o*i-r*a)*g,s[3]=d*g,s[4]=(c*e-r*h)*g,s[5]=(-o*e+r*n)*g,s[6]=f*g,s[7]=(-l*e+i*h)*g,s[8]=(a*e-i*n)*g,s):null}function ye(s,t,e){let i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=e[0],f=e[1],g=e[2],x=e[3],p=e[4],m=e[5],M=e[6],E=e[7],A=e[8];return s[0]=d*i+f*a+g*l,s[1]=d*r+f*o+g*c,s[2]=d*n+f*h+g*u,s[3]=x*i+p*a+m*l,s[4]=x*r+p*o+m*c,s[5]=x*n+p*h+m*u,s[6]=M*i+E*a+A*l,s[7]=M*r+E*o+A*c,s[8]=M*n+E*h+A*u,s}function Mi(s,t,e){let i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=e[0],f=e[1];return s[0]=i,s[1]=r,s[2]=n,s[3]=a,s[4]=o,s[5]=h,s[6]=d*i+f*a+l,s[7]=d*r+f*o+c,s[8]=d*n+f*h+u,s}function Ai(s,t,e){let i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=Math.sin(e),f=Math.cos(e);return s[0]=f*i+d*a,s[1]=f*r+d*o,s[2]=f*n+d*h,s[3]=f*a-d*i,s[4]=f*o-d*r,s[5]=f*h-d*n,s[6]=l,s[7]=c,s[8]=u,s}function _i(s,t,e){let i=e[0],r=e[1];return s[0]=i*t[0],s[1]=i*t[1],s[2]=i*t[2],s[3]=r*t[3],s[4]=r*t[4],s[5]=r*t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s}function bi(s,t){let e=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],f=t[11],g=t[12],x=t[13],p=t[14],m=t[15],M=e*o-i*a,E=e*h-r*a,A=e*l-n*a,y=i*h-r*o,w=i*l-n*o,b=r*l-n*h,z=c*x-u*g,R=c*p-d*g,v=c*m-f*g,S=u*p-d*x,T=u*m-f*x,F=d*m-f*p,L=M*F-E*T+A*S+y*v-w*R+b*z;return L?(L=1/L,s[0]=(o*F-h*T+l*S)*L,s[1]=(h*v-a*F-l*R)*L,s[2]=(a*T-o*v+l*z)*L,s[3]=(r*T-i*F-n*S)*L,s[4]=(e*F-r*v+n*R)*L,s[5]=(i*v-e*T-n*z)*L,s[6]=(x*b-p*w+m*y)*L,s[7]=(p*A-g*b-m*E)*L,s[8]=(g*w-x*A+m*M)*L,s):null}class Ht extends Array{constructor(t=1,e=0,i=0,r=0,n=1,a=0,o=0,h=0,l=1){return super(t,e,i,r,n,a,o,h,l),this}set(t,e,i,r,n,a,o,h,l){return t.length?this.copy(t):(yi(this,t,e,i,r,n,a,o,h,l),this)}translate(t,e=this){return Mi(this,e,t),this}rotate(t,e=this){return Ai(this,e,t),this}scale(t,e=this){return _i(this,e,t),this}multiply(t,e){return e?ye(this,t,e):ye(this,this,t),this}identity(){return wi(this),this}copy(t){return xi(this,t),this}fromMatrix4(t){return gi(this,t),this}fromQuaternion(t){return mi(this,t),this}fromBasis(t,e,i){return this.set(t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]),this}inverse(t=this){return Ei(this,t),this}getNormalMatrix(t){return bi(this,t),this}}let vi=0;class W extends ot{constructor(t,{geometry:e,program:i,mode:r=t.TRIANGLES,frustumCulled:n=!0,renderOrder:a=0}={}){super(),t.canvas||console.error("gl not passed as first argument to Mesh"),this.gl=t,this.id=vi++,this.geometry=e,this.program=i,this.mode=r,this.frustumCulled=n,this.renderOrder=a,this.modelViewMatrix=new V,this.normalMatrix=new Ht,this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[]}onBeforeRender(t){return this.beforeRenderCallbacks.push(t),this}onAfterRender(t){return this.afterRenderCallbacks.push(t),this}draw({camera:t}={}){t&&(this.program.uniforms.modelMatrix||Object.assign(this.program.uniforms,{modelMatrix:{value:null},viewMatrix:{value:null},modelViewMatrix:{value:null},normalMatrix:{value:null},projectionMatrix:{value:null},cameraPosition:{value:null}}),this.program.uniforms.projectionMatrix.value=t.projectionMatrix,this.program.uniforms.cameraPosition.value=t.worldPosition,this.program.uniforms.viewMatrix.value=t.viewMatrix,this.modelViewMatrix.multiply(t.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix),this.program.uniforms.modelMatrix.value=this.worldMatrix,this.program.uniforms.modelViewMatrix.value=this.modelViewMatrix,this.program.uniforms.normalMatrix.value=this.normalMatrix),this.beforeRenderCallbacks.forEach(i=>i&&i({mesh:this,camera:t}));let e=this.program.cullFace&&this.worldMatrix.determinant()<0;this.program.use({flipFaces:e}),this.geometry.draw({mode:this.mode,program:this.program}),this.afterRenderCallbacks.forEach(i=>i&&i({mesh:this,camera:t}))}}const we=new Uint8Array(4);function Ee(s){return(s&s-1)===0}let Ti=1;class H{constructor(t,{image:e,target:i=t.TEXTURE_2D,type:r=t.UNSIGNED_BYTE,format:n=t.RGBA,internalFormat:a=n,wrapS:o=t.CLAMP_TO_EDGE,wrapT:h=t.CLAMP_TO_EDGE,wrapR:l=t.CLAMP_TO_EDGE,generateMipmaps:c=i===(t.TEXTURE_2D||t.TEXTURE_CUBE_MAP),minFilter:u=c?t.NEAREST_MIPMAP_LINEAR:t.LINEAR,magFilter:d=t.LINEAR,premultiplyAlpha:f=!1,unpackAlignment:g=4,flipY:x=i==(t.TEXTURE_2D||t.TEXTURE_3D),anisotropy:p=0,level:m=0,width:M,height:E=M,length:A=1}={}){this.gl=t,this.id=Ti++,this.image=e,this.target=i,this.type=r,this.format=n,this.internalFormat=a,this.minFilter=u,this.magFilter=d,this.wrapS=o,this.wrapT=h,this.wrapR=l,this.generateMipmaps=c,this.premultiplyAlpha=f,this.unpackAlignment=g,this.flipY=x,this.anisotropy=Math.min(p,this.gl.renderer.parameters.maxAnisotropy),this.level=m,this.width=M,this.height=E,this.length=A,this.texture=this.gl.createTexture(),this.store={image:null},this.glState=this.gl.renderer.state,this.state={},this.state.minFilter=this.gl.NEAREST_MIPMAP_LINEAR,this.state.magFilter=this.gl.LINEAR,this.state.wrapS=this.gl.REPEAT,this.state.wrapT=this.gl.REPEAT,this.state.anisotropy=0}bind(){this.glState.textureUnits[this.glState.activeTextureUnit]!==this.id&&(this.gl.bindTexture(this.target,this.texture),this.glState.textureUnits[this.glState.activeTextureUnit]=this.id)}update(t=0){const e=!(this.image===this.store.image&&!this.needsUpdate);if((e||this.glState.textureUnits[t]!==this.id)&&(this.gl.renderer.activeTexture(t),this.bind()),!!e){if(this.needsUpdate=!1,this.flipY!==this.glState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.glState.flipY=this.flipY),this.premultiplyAlpha!==this.glState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.glState.premultiplyAlpha=this.premultiplyAlpha),this.unpackAlignment!==this.glState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.unpackAlignment),this.glState.unpackAlignment=this.unpackAlignment),this.minFilter!==this.state.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.minFilter),this.state.minFilter=this.minFilter),this.magFilter!==this.state.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.magFilter),this.state.magFilter=this.magFilter),this.wrapS!==this.state.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.wrapS),this.state.wrapS=this.wrapS),this.wrapT!==this.state.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.wrapT),this.state.wrapT=this.wrapT),this.wrapR!==this.state.wrapR&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_R,this.wrapR),this.state.wrapR=this.wrapR),this.anisotropy&&this.anisotropy!==this.state.anisotropy&&(this.gl.texParameterf(this.target,this.gl.renderer.getExtension("EXT_texture_filter_anisotropic").TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropy),this.state.anisotropy=this.anisotropy),this.image){if(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.target===this.gl.TEXTURE_CUBE_MAP)for(let i=0;i<6;i++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,this.level,this.internalFormat,this.format,this.type,this.image[i]);else if(ArrayBuffer.isView(this.image))this.target===this.gl.TEXTURE_2D?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,this.image):(this.target===this.gl.TEXTURE_2D_ARRAY||this.target===this.gl.TEXTURE_3D)&&this.gl.texImage3D(this.target,this.level,this.internalFormat,this.width,this.height,this.length,0,this.format,this.type,this.image);else if(this.image.isCompressedTexture)for(let i=0;i<this.image.length;i++)this.gl.compressedTexImage2D(this.target,i,this.internalFormat,this.image[i].width,this.image[i].height,0,this.image[i].data);else this.target===this.gl.TEXTURE_2D?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.format,this.type,this.image):this.gl.texImage3D(this.target,this.level,this.internalFormat,this.width,this.height,this.length,0,this.format,this.type,this.image);this.generateMipmaps&&(!this.gl.renderer.isWebgl2&&(!Ee(this.image.width)||!Ee(this.image.height))?(this.generateMipmaps=!1,this.wrapS=this.wrapT=this.gl.CLAMP_TO_EDGE,this.minFilter=this.gl.LINEAR):this.gl.generateMipmap(this.target)),this.onUpdate&&this.onUpdate()}else if(this.target===this.gl.TEXTURE_CUBE_MAP)for(let i=0;i<6;i++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,we);else this.width?this.target===this.gl.TEXTURE_2D?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,null):this.gl.texImage3D(this.target,this.level,this.internalFormat,this.width,this.height,this.length,0,this.format,this.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,we);this.store.image=this.image}}}class Z{constructor(t,{width:e=t.canvas.width,height:i=t.canvas.height,target:r=t.FRAMEBUFFER,color:n=1,depth:a=!0,stencil:o=!1,depthTexture:h=!1,wrapS:l=t.CLAMP_TO_EDGE,wrapT:c=t.CLAMP_TO_EDGE,wrapR:u=t.CLAMP_TO_EDGE,minFilter:d=t.LINEAR,magFilter:f=d,type:g=t.UNSIGNED_BYTE,format:x=t.RGBA,internalFormat:p=x,unpackAlignment:m,premultiplyAlpha:M}={}){this.gl=t,this.width=e,this.height=i,this.depth=a,this.stencil=o,this.buffer=this.gl.createFramebuffer(),this.target=r,this.gl.renderer.bindFramebuffer(this),this.textures=[];const E=[];for(let A=0;A<n;A++)this.textures.push(new H(t,{width:e,height:i,wrapS:l,wrapT:c,wrapR:u,minFilter:d,magFilter:f,type:g,format:x,internalFormat:p,unpackAlignment:m,premultiplyAlpha:M,flipY:!1,generateMipmaps:!1})),this.textures[A].update(),this.gl.framebufferTexture2D(this.target,this.gl.COLOR_ATTACHMENT0+A,this.gl.TEXTURE_2D,this.textures[A].texture,0),E.push(this.gl.COLOR_ATTACHMENT0+A);E.length>1&&this.gl.renderer.drawBuffers(E),this.texture=this.textures[0],h&&(this.gl.renderer.isWebgl2||this.gl.renderer.getExtension("WEBGL_depth_texture"))?(this.depthTexture=new H(t,{width:e,height:i,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,format:this.stencil?this.gl.DEPTH_STENCIL:this.gl.DEPTH_COMPONENT,internalFormat:t.renderer.isWebgl2?this.stencil?this.gl.DEPTH24_STENCIL8:this.gl.DEPTH_COMPONENT16:this.gl.DEPTH_COMPONENT,type:this.stencil?this.gl.UNSIGNED_INT_24_8:this.gl.UNSIGNED_INT}),this.depthTexture.update(),this.gl.framebufferTexture2D(this.target,this.stencil?this.gl.DEPTH_STENCIL_ATTACHMENT:this.gl.DEPTH_ATTACHMENT,this.gl.TEXTURE_2D,this.depthTexture.texture,0)):(a&&!o&&(this.depthBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,i),this.gl.framebufferRenderbuffer(this.target,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer)),o&&!a&&(this.stencilBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.stencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,e,i),this.gl.framebufferRenderbuffer(this.target,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,this.stencilBuffer)),a&&o&&(this.depthStencilBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthStencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_STENCIL,e,i),this.gl.framebufferRenderbuffer(this.target,this.gl.DEPTH_STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,this.depthStencilBuffer))),this.gl.renderer.bindFramebuffer({target:this.target})}setSize(t,e){if(!(this.width===t&&this.height===e)){this.width=t,this.height=e,this.gl.renderer.bindFramebuffer(this);for(let i=0;i<this.textures.length;i++)this.textures[i].width=t,this.textures[i].height=e,this.textures[i].needsUpdate=!0,this.textures[i].update(),this.gl.framebufferTexture2D(this.target,this.gl.COLOR_ATTACHMENT0+i,this.gl.TEXTURE_2D,this.textures[i].texture,0);this.depthTexture?(this.depthTexture.width=t,this.depthTexture.height=e,this.depthTexture.needsUpdate=!0,this.depthTexture.update(),this.gl.framebufferTexture2D(this.target,this.gl.DEPTH_ATTACHMENT,this.gl.TEXTURE_2D,this.depthTexture.texture,0)):(this.depthBuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,t,e)),this.stencilBuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.stencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,t,e)),this.depthStencilBuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthStencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_STENCIL,t,e))),this.gl.renderer.bindFramebuffer({target:this.target})}}}const Me={black:"#000000",white:"#ffffff",red:"#ff0000",green:"#00ff00",blue:"#0000ff",fuchsia:"#ff00ff",cyan:"#00ffff",yellow:"#ffff00",orange:"#ff8000"};function Ae(s){s.length===4&&(s=s[0]+s[1]+s[1]+s[2]+s[2]+s[3]+s[3]);const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return t||console.warn(`Unable to convert hex string ${s} to rgb values`),[parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255]}function Ri(s){return s=parseInt(s),[(s>>16&255)/255,(s>>8&255)/255,(s&255)/255]}function _e(s){return s===void 0?[0,0,0]:arguments.length===3?arguments:isNaN(s)?s[0]==="#"?Ae(s):Me[s.toLowerCase()]?Ae(Me[s.toLowerCase()]):(console.warn("Color format not recognised"),[0,0,0]):Ri(s)}class ns extends Array{constructor(t){return Array.isArray(t)?super(...t):super(..._e(...arguments))}get r(){return this[0]}get g(){return this[1]}get b(){return this[2]}set r(t){this[0]=t}set g(t){this[1]=t}set b(t){this[2]=t}set(t){return Array.isArray(t)?this.copy(t):this.copy(_e(...arguments))}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this}}function Fi(s,t){return s[0]=t[0],s[1]=t[1],s}function Li(s,t,e){return s[0]=t,s[1]=e,s}function be(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}function ve(s,t,e){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s}function Si(s,t,e){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s}function zi(s,t,e){return s[0]=t[0]/e[0],s[1]=t[1]/e[1],s}function Tt(s,t,e){return s[0]=t[0]*e,s[1]=t[1]*e,s}function Pi(s,t){var e=t[0]-s[0],i=t[1]-s[1];return Math.sqrt(e*e+i*i)}function Ci(s,t){var e=t[0]-s[0],i=t[1]-s[1];return e*e+i*i}function Te(s){var t=s[0],e=s[1];return Math.sqrt(t*t+e*e)}function Ni(s){var t=s[0],e=s[1];return t*t+e*e}function Ii(s,t){return s[0]=-t[0],s[1]=-t[1],s}function Di(s,t){return s[0]=1/t[0],s[1]=1/t[1],s}function Oi(s,t){var e=t[0],i=t[1],r=e*e+i*i;return r>0&&(r=1/Math.sqrt(r)),s[0]=t[0]*r,s[1]=t[1]*r,s}function Bi(s,t){return s[0]*t[0]+s[1]*t[1]}function Re(s,t){return s[0]*t[1]-s[1]*t[0]}function Ui(s,t,e,i){var r=t[0],n=t[1];return s[0]=r+i*(e[0]-r),s[1]=n+i*(e[1]-n),s}function ki(s,t,e,i,r){const n=Math.exp(-i*r);let a=t[0],o=t[1];return s[0]=e[0]+(a-e[0])*n,s[1]=e[1]+(o-e[1])*n,s}function Vi(s,t,e){var i=t[0],r=t[1];return s[0]=e[0]*i+e[3]*r+e[6],s[1]=e[1]*i+e[4]*r+e[7],s}function Gi(s,t,e){let i=t[0],r=t[1];return s[0]=e[0]*i+e[4]*r+e[12],s[1]=e[1]*i+e[5]*r+e[13],s}function $i(s,t){return s[0]===t[0]&&s[1]===t[1]}class G extends Array{constructor(t=0,e=t){return super(t,e),this}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}set(t,e=t){return t.length?this.copy(t):(Li(this,t,e),this)}copy(t){return Fi(this,t),this}add(t,e){return e?be(this,t,e):be(this,this,t),this}sub(t,e){return e?ve(this,t,e):ve(this,this,t),this}multiply(t){return t.length?Si(this,this,t):Tt(this,this,t),this}divide(t){return t.length?zi(this,this,t):Tt(this,this,1/t),this}inverse(t=this){return Di(this,t),this}len(){return Te(this)}distance(t){return t?Pi(this,t):Te(this)}squaredLen(){return this.squaredDistance()}squaredDistance(t){return t?Ci(this,t):Ni(this)}negate(t=this){return Ii(this,t),this}cross(t,e){return e?Re(t,e):Re(this,t)}scale(t){return Tt(this,this,t),this}normalize(){return Oi(this,this),this}dot(t){return Bi(this,t)}equals(t){return $i(this,t)}applyMatrix3(t){return Vi(this,this,t),this}applyMatrix4(t){return Gi(this,this,t),this}lerp(t,e){return Ui(this,this,t,e),this}smoothLerp(t,e,i){return ki(this,this,t,e,i),this}clone(){return new G(this[0],this[1])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t}}class Wi extends Array{constructor(t=0,e=t,i=t,r=t){return super(t,e,i,r),this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set w(t){this[3]=t}set(t,e=t,i=t,r=t){return t.length?this.copy(t):(Ze(this,t,e,i,r),this)}copy(t){return Qe(this,t),this}normalize(){return Je(this,this),this}multiply(t){return Ps(this,this,t),this}dot(t){return ts(this,t)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}class Q extends ${constructor(t,{width:e=1,height:i=1,widthSegments:r=1,heightSegments:n=1,attributes:a={}}={}){const o=r,h=n,l=(o+1)*(h+1),c=o*h*6,u=new Float32Array(l*3),d=new Float32Array(l*3),f=new Float32Array(l*2),g=c>65536?new Uint32Array(c):new Uint16Array(c);Q.buildPlane(u,d,f,g,e,i,0,o,h),Object.assign(a,{position:{size:3,data:u},normal:{size:3,data:d},uv:{size:2,data:f},index:{data:g}}),super(t,a)}static buildPlane(t,e,i,r,n,a,o,h,l,c=0,u=1,d=2,f=1,g=-1,x=0,p=0){const m=x,M=n/h,E=a/l;for(let A=0;A<=l;A++){let y=A*E-a/2;for(let w=0;w<=h;w++,x++){let b=w*M-n/2;if(t[x*3+c]=b*f,t[x*3+u]=y*g,t[x*3+d]=o/2,e[x*3+c]=0,e[x*3+u]=0,e[x*3+d]=o>=0?1:-1,i[x*2]=w/h,i[x*2+1]=1-A/l,A===l||w===h)continue;let z=m+w+A*(h+1),R=m+w+(A+1)*(h+1),v=m+w+(A+1)*(h+1)+1,S=m+w+A*(h+1)+1;r[p*6]=z,r[p*6+1]=R,r[p*6+2]=S,r[p*6+3]=R,r[p*6+4]=v,r[p*6+5]=S,p++}}}}class Hr extends ${constructor(t,{width:e=1,height:i=1,depth:r=1,widthSegments:n=1,heightSegments:a=1,depthSegments:o=1,attributes:h={}}={}){const l=n,c=a,u=o,d=(l+1)*(c+1)*2+(l+1)*(u+1)*2+(c+1)*(u+1)*2,f=(l*c*2+l*u*2+c*u*2)*6,g=new Float32Array(d*3),x=new Float32Array(d*3),p=new Float32Array(d*2),m=d>65536?new Uint32Array(f):new Uint16Array(f);let M=0,E=0;Q.buildPlane(g,x,p,m,r,i,e,u,c,2,1,0,-1,-1,M,E),M+=(u+1)*(c+1),E+=u*c,Q.buildPlane(g,x,p,m,r,i,-e,u,c,2,1,0,1,-1,M,E),M+=(u+1)*(c+1),E+=u*c,Q.buildPlane(g,x,p,m,e,r,i,u,l,0,2,1,1,1,M,E),M+=(l+1)*(u+1),E+=l*u,Q.buildPlane(g,x,p,m,e,r,-i,u,l,0,2,1,1,-1,M,E),M+=(l+1)*(u+1),E+=l*u,Q.buildPlane(g,x,p,m,e,i,-r,l,c,0,1,2,-1,-1,M,E),M+=(l+1)*(c+1),E+=l*c,Q.buildPlane(g,x,p,m,e,i,r,l,c,0,1,2,1,-1,M,E),Object.assign(h,{position:{size:3,data:g},normal:{size:3,data:x},uv:{size:2,data:p},index:{data:m}}),super(t,h)}}class Kr extends ${constructor(t,{radius:e=.5,widthSegments:i=16,heightSegments:r=Math.ceil(i*.5),phiStart:n=0,phiLength:a=Math.PI*2,thetaStart:o=0,thetaLength:h=Math.PI,attributes:l={}}={}){const c=i,u=r,d=n,f=a,g=o,x=h,p=(c+1)*(u+1),m=c*u*6,M=new Float32Array(p*3),E=new Float32Array(p*3),A=new Float32Array(p*2),y=p>65536?new Uint32Array(m):new Uint16Array(m);let w=0,b=0,z=0,R=g+x;const v=[];let S=new _;for(let T=0;T<=u;T++){let F=[],L=T/u;for(let C=0;C<=c;C++,w++){let N=C/c,D=-e*Math.cos(d+N*f)*Math.sin(g+L*x),I=e*Math.cos(g+L*x),B=e*Math.sin(d+N*f)*Math.sin(g+L*x);M[w*3]=D,M[w*3+1]=I,M[w*3+2]=B,S.set(D,I,B).normalize(),E[w*3]=S.x,E[w*3+1]=S.y,E[w*3+2]=S.z,A[w*2]=N,A[w*2+1]=1-L,F.push(b++)}v.push(F)}for(let T=0;T<u;T++)for(let F=0;F<c;F++){let L=v[T][F+1],C=v[T][F],N=v[T+1][F],D=v[T+1][F+1];(T!==0||g>0)&&(y[z*3]=L,y[z*3+1]=C,y[z*3+2]=D,z++),(T!==u-1||R<Math.PI)&&(y[z*3]=C,y[z*3+1]=N,y[z*3+2]=D,z++)}Object.assign(l,{position:{size:3,data:M},normal:{size:3,data:E},uv:{size:2,data:A},index:{data:y}}),super(t,l)}}class Qr extends ${constructor(t,{radiusTop:e=.5,radiusBottom:i=.5,height:r=1,radialSegments:n=8,heightSegments:a=1,openEnded:o=!1,thetaStart:h=0,thetaLength:l=Math.PI*2,attributes:c={}}={}){const u=n,d=a,f=h,g=l,x=o?0:i&&e?2:1,p=(u+1)*(d+1+x)+x,m=u*d*6+x*u*3,M=new Float32Array(p*3),E=new Float32Array(p*3),A=new Float32Array(p*2),y=p>65536?new Uint32Array(m):new Uint16Array(m);let w=0,b=0;const z=[];R(),o||(e&&v(!0),i&&v(!1));function R(){let S,T;const F=new _,L=(i-e)/r;for(T=0;T<=d;T++){const C=[],N=T/d,D=N*(i-e)+e;for(S=0;S<=u;S++){const I=S/u,B=I*g+f,Y=Math.sin(B),J=Math.cos(B);M.set([D*Y,(.5-N)*r,D*J],w*3),F.set(Y,L,J).normalize(),E.set([F.x,F.y,F.z],w*3),A.set([I,1-N],w*2),C.push(w++)}z.push(C)}for(S=0;S<u;S++)for(T=0;T<d;T++){const C=z[T][S],N=z[T+1][S],D=z[T+1][S+1],I=z[T][S+1];y.set([C,N,I,N,D,I],b*3),b+=2}}function v(S){let T;const F=S===!0?e:i,L=S===!0?1:-1,C=w;for(M.set([0,.5*r*L,0],w*3),E.set([0,L,0],w*3),A.set([.5,.5],w*2),w++,T=0;T<=u;T++){const D=T/u*g+f,I=Math.cos(D),B=Math.sin(D);M.set([F*B,.5*r*L,F*I],w*3),E.set([0,L,0],w*3),A.set([I*.5+.5,B*.5*L+.5],w*2),w++}for(T=0;T<u;T++){const N=C+T+1;S?y.set([N,N+1,C],b*3):y.set([N+1,N,C],b*3),b++}}Object.assign(c,{position:{size:3,data:M},normal:{size:3,data:E},uv:{size:2,data:A},index:{data:y}}),super(t,c)}}class Kt extends ${constructor(t,{attributes:e={}}={}){Object.assign(e,{position:{size:2,data:new Float32Array([-1,-1,3,-1,-1,3])},uv:{size:2,data:new Float32Array([0,0,2,0,0,2])}}),super(t,e)}}class Zr extends ${constructor(t,{radius:e=.5,tube:i=.2,radialSegments:r=8,tubularSegments:n=6,arc:a=Math.PI*2,attributes:o={}}={}){const h=(r+1)*(n+1),l=r*n*6,c=new Float32Array(h*3),u=new Float32Array(h*3),d=new Float32Array(h*2),f=h>65536?new Uint32Array(l):new Uint16Array(l),g=new _,x=new _,p=new _;let m=0;for(let M=0;M<=r;M++)for(let E=0;E<=n;E++,m++){const A=E/n*a,y=M/r*Math.PI*2;x.x=(e+i*Math.cos(y))*Math.cos(A),x.y=(e+i*Math.cos(y))*Math.sin(A),x.z=i*Math.sin(y),c.set([x.x,x.y,x.z],m*3),g.x=e*Math.cos(A),g.y=e*Math.sin(A),p.sub(x,g).normalize(),u.set([p.x,p.y,p.z],m*3),d.set([E/n,M/r],m*2)}m=0;for(let M=1;M<=r;M++)for(let E=1;E<=n;E++,m++){const A=(n+1)*M+E-1,y=(n+1)*(M-1)+E-1,w=(n+1)*(M-1)+E,b=(n+1)*M+E;f.set([A,y,b,y,w,b],m*6)}Object.assign(o,{position:{size:3,data:c},normal:{size:3,data:u},uv:{size:2,data:d},index:{data:f}}),super(t,o)}}const U={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,DOLLY_PAN:3},K=new _,X=new G,j=new G;function Jr(s,{element:t=document,enabled:e=!0,target:i=new _,ease:r=.25,inertia:n=.85,enableRotate:a=!0,rotateSpeed:o=.1,autoRotate:h=!1,autoRotateSpeed:l=1,enableZoom:c=!0,zoomSpeed:u=1,zoomStyle:d="dolly",enablePan:f=!0,panSpeed:g=.1,minPolarAngle:x=0,maxPolarAngle:p=Math.PI,minAzimuthAngle:m=-1/0,maxAzimuthAngle:M=1/0,minDistance:E=0,maxDistance:A=1/0}={}){this.enabled=e,this.target=i,this.zoomStyle=d,r=r||1,n=n||0,this.minDistance=E,this.maxDistance=A;const y={radius:1,phi:0,theta:0},w={radius:1,phi:0,theta:0},b={radius:1,phi:0,theta:0},z=new _,R=new _;R.copy(s.position).sub(this.target),b.radius=w.radius=R.distance(),b.theta=w.theta=Math.atan2(R.x,R.z),b.phi=w.phi=Math.acos(Math.min(Math.max(R.y/w.radius,-1),1)),this.offset=R,this.update=()=>{h&&B(),w.radius*=y.radius,w.theta+=y.theta,w.phi+=y.phi,w.theta=Math.max(m,Math.min(M,w.theta)),w.phi=Math.max(x,Math.min(p,w.phi)),w.radius=Math.max(this.minDistance,Math.min(this.maxDistance,w.radius)),b.phi+=(w.phi-b.phi)*r,b.theta+=(w.theta-b.theta)*r,b.radius+=(w.radius-b.radius)*r,this.target.add(z);let P=b.radius*Math.sin(Math.max(1e-6,b.phi));R.x=P*Math.sin(b.theta),R.y=b.radius*Math.cos(b.phi),R.z=P*Math.cos(b.theta),s.position.copy(this.target).add(R),s.lookAt(this.target),y.theta*=n,y.phi*=n,z.multiply(n),y.radius=1},this.forcePosition=()=>{R.copy(s.position).sub(this.target),b.radius=w.radius=R.distance(),b.theta=w.theta=Math.atan2(R.x,R.z),b.phi=w.phi=Math.acos(Math.min(Math.max(R.y/w.radius,-1),1)),s.lookAt(this.target)};const v=new G,S=new G,T=new G;let F=U.NONE;this.mouseButtons={ORBIT:0,ZOOM:1,PAN:2};function L(){return Math.pow(.95,u)}function C(P,O){K.set(O[0],O[1],O[2]),K.multiply(-P),z.add(K)}function N(P,O){K.set(O[4],O[5],O[6]),K.multiply(P),z.add(K)}const D=(P,O)=>{let k=t===document?document.body:t;K.copy(s.position).sub(this.target);let et=K.distance();et*=Math.tan((s.fov||45)/2*Math.PI/180),C(2*P*et/k.clientHeight,s.matrix),N(2*O*et/k.clientHeight,s.matrix)},I=P=>{this.zoomStyle==="dolly"?y.radius/=P:(s.fov/=P,s.type==="orthographic"?s.orthographic():s.perspective())};function B(){const P=2*Math.PI/60/60*l;y.theta-=P}function Y(P,O){X.set(P,O),j.sub(X,v).multiply(o);let k=t===document?document.body:t;y.theta-=2*Math.PI*j.x/k.clientHeight,y.phi-=2*Math.PI*j.y/k.clientHeight,v.copy(X)}function J(P){X.set(P.clientX,P.clientY),j.sub(X,T),j.y>0?I(L()):j.y<0&&I(1/L()),T.copy(X)}function tt(P,O){X.set(P,O),j.sub(X,S).multiply(g),D(j.x,j.y),S.copy(X)}function os(P){if(c){let O=P.touches[0].pageX-P.touches[1].pageX,k=P.touches[0].pageY-P.touches[1].pageY,et=Math.sqrt(O*O+k*k);T.set(0,et)}if(f){let O=.5*(P.touches[0].pageX+P.touches[1].pageX),k=.5*(P.touches[0].pageY+P.touches[1].pageY);S.set(O,k)}}function ls(P){if(c){let O=P.touches[0].pageX-P.touches[1].pageX,k=P.touches[0].pageY-P.touches[1].pageY,et=Math.sqrt(O*O+k*k);X.set(0,et),j.set(0,Math.pow(X.y/T.y,u)),I(j.y),T.copy(X)}if(f){let O=.5*(P.touches[0].pageX+P.touches[1].pageX),k=.5*(P.touches[0].pageY+P.touches[1].pageY);tt(O,k)}}const Zt=P=>{if(this.enabled){switch(P.button){case this.mouseButtons.ORBIT:if(a===!1)return;v.set(P.clientX,P.clientY),F=U.ROTATE;break;case this.mouseButtons.ZOOM:if(c===!1)return;T.set(P.clientX,P.clientY),F=U.DOLLY;break;case this.mouseButtons.PAN:if(f===!1)return;S.set(P.clientX,P.clientY),F=U.PAN;break}F!==U.NONE&&(window.addEventListener("mousemove",Et,!1),window.addEventListener("mouseup",Mt,!1))}},Et=P=>{if(this.enabled)switch(F){case U.ROTATE:if(a===!1)return;Y(P.clientX,P.clientY);break;case U.DOLLY:if(c===!1)return;J(P);break;case U.PAN:if(f===!1)return;tt(P.clientX,P.clientY);break}},Mt=()=>{window.removeEventListener("mousemove",Et,!1),window.removeEventListener("mouseup",Mt,!1),F=U.NONE},Jt=P=>{!this.enabled||!c||F!==U.NONE&&F!==U.ROTATE||(P.stopPropagation(),P.preventDefault(),P.deltaY<0?I(1/L()):P.deltaY>0&&I(L()))},te=P=>{if(this.enabled)switch(P.preventDefault(),P.touches.length){case 1:if(a===!1)return;v.set(P.touches[0].pageX,P.touches[0].pageY),F=U.ROTATE;break;case 2:if(c===!1&&f===!1)return;os(P),F=U.DOLLY_PAN;break;default:F=U.NONE}},ee=P=>{if(this.enabled)switch(P.preventDefault(),P.stopPropagation(),P.touches.length){case 1:if(a===!1)return;Y(P.touches[0].pageX,P.touches[0].pageY);break;case 2:if(c===!1&&f===!1)return;ls(P);break;default:F=U.NONE}},se=()=>{this.enabled&&(F=U.NONE)},ie=P=>{this.enabled&&P.preventDefault()};function cs(){t.addEventListener("contextmenu",ie,!1),t.addEventListener("mousedown",Zt,!1),t.addEventListener("wheel",Jt,{passive:!1}),t.addEventListener("touchstart",te,{passive:!1}),t.addEventListener("touchend",se,!1),t.addEventListener("touchmove",ee,{passive:!1})}this.remove=function(){t.removeEventListener("contextmenu",ie),t.removeEventListener("mousedown",Zt),t.removeEventListener("wheel",Jt),t.removeEventListener("touchstart",te),t.removeEventListener("touchend",se),t.removeEventListener("touchmove",ee),window.removeEventListener("mousemove",Et),window.removeEventListener("mouseup",Mt)},cs()}const Xi=new G,qi=new G,Yi=new G,Rt=new _,Fe=new _,Le=new _,ji=new _,Hi=new _,Ki=new _,Se=new _,Ft=new _,ze=new _,Pe=new _,Qi=new _,Ce=new V;class tn{constructor(){this.origin=new _,this.direction=new _}castMouse(t,e=[0,0]){if(t.type==="orthographic"){const{left:i,right:r,bottom:n,top:a,zoom:o}=t,h=i/o+(r-i)/o*(e[0]*.5+.5),l=n/o+(a-n)/o*(e[1]*.5+.5);this.origin.set(h,l,0),this.origin.applyMatrix4(t.worldMatrix),this.direction.x=-t.worldMatrix[8],this.direction.y=-t.worldMatrix[9],this.direction.z=-t.worldMatrix[10]}else t.worldMatrix.getTranslation(this.origin),this.direction.set(e[0],e[1],.5),t.unproject(this.direction),this.direction.sub(this.origin).normalize()}intersectBounds(t,{maxDistance:e,output:i=[]}={}){Array.isArray(t)||(t=[t]);const r=Ce,n=Rt,a=Fe,o=i;return o.length=0,t.forEach(h=>{(!h.geometry.bounds||h.geometry.bounds.radius===1/0)&&h.geometry.computeBoundingSphere();const l=h.geometry.bounds;r.inverse(h.worldMatrix);let c;if(e&&(a.copy(this.direction).scaleRotateMatrix4(r),c=e*a.len()),n.copy(this.origin).applyMatrix4(r),a.copy(this.direction).transformDirection(r),e&&n.distance(l.center)-l.radius>c)return;let u=0;if(h.geometry.raycast==="sphere"){if(n.distance(l.center)>l.radius&&(u=this.intersectSphere(l,n,a),!u))return}else if((n.x<l.min.x||n.x>l.max.x||n.y<l.min.y||n.y>l.max.y||n.z<l.min.z||n.z>l.max.z)&&(u=this.intersectBox(l,n,a),!u))return;e&&u>c||(h.hit||(h.hit={localPoint:new _,point:new _}),h.hit.localPoint.copy(a).multiply(u).add(n),h.hit.point.copy(h.hit.localPoint).applyMatrix4(h.worldMatrix),h.hit.distance=h.hit.point.distance(this.origin),o.push(h))}),o.sort((h,l)=>h.hit.distance-l.hit.distance),o}intersectMeshes(t,{cullFace:e=!0,maxDistance:i,includeUV:r=!0,includeNormal:n=!0,output:a=[]}={}){const o=this.intersectBounds(t,{maxDistance:i,output:a});if(!o.length)return o;const h=Ce,l=Rt,c=Fe,u=Le,d=ji,f=Hi,g=Ki,x=Se,p=Ft,m=Xi,M=qi,E=Yi;for(let A=o.length-1;A>=0;A--){const y=o[A];h.inverse(y.worldMatrix);let w;i&&(c.copy(this.direction).scaleRotateMatrix4(h),w=i*c.len()),l.copy(this.origin).applyMatrix4(h),c.copy(this.direction).transformDirection(h);let b=0,z,R,v;const S=y.geometry,T=S.attributes,F=T.index,L=T.position,C=Math.max(0,S.drawRange.start),N=Math.min(F?F.count:L.count,S.drawRange.start+S.drawRange.count),D=L.size;for(let I=C;I<N;I+=3){const B=F?F.data[I]:I,Y=F?F.data[I+1]:I+1,J=F?F.data[I+2]:I+2;u.fromArray(L.data,B*D),d.fromArray(L.data,Y*D),f.fromArray(L.data,J*D);const tt=this.intersectTriangle(u,d,f,e,l,c,x);tt&&(i&&tt>w||(!b||tt<b)&&(b=tt,z=B,R=Y,v=J,g.copy(x)))}b||o.splice(A,1),y.hit.localPoint.copy(c).multiply(b).add(l),y.hit.point.copy(y.hit.localPoint).applyMatrix4(y.worldMatrix),y.hit.distance=y.hit.point.distance(this.origin),y.hit.faceNormal||(y.hit.localFaceNormal=new _,y.hit.faceNormal=new _,y.hit.uv=new G,y.hit.localNormal=new _,y.hit.normal=new _),y.hit.localFaceNormal.copy(g),y.hit.faceNormal.copy(y.hit.localFaceNormal).transformDirection(y.worldMatrix),(r||n)&&(u.fromArray(L.data,z*3),d.fromArray(L.data,R*3),f.fromArray(L.data,v*3),this.getBarycoord(y.hit.localPoint,u,d,f,p)),r&&T.uv&&(m.fromArray(T.uv.data,z*2),M.fromArray(T.uv.data,R*2),E.fromArray(T.uv.data,v*2),y.hit.uv.set(m.x*p.x+M.x*p.y+E.x*p.z,m.y*p.x+M.y*p.y+E.y*p.z)),n&&T.normal&&(u.fromArray(T.normal.data,z*3),d.fromArray(T.normal.data,R*3),f.fromArray(T.normal.data,v*3),y.hit.localNormal.set(u.x*p.x+d.x*p.y+f.x*p.z,u.y*p.x+d.y*p.y+f.y*p.z,u.z*p.x+d.z*p.y+f.z*p.z),y.hit.normal.copy(y.hit.localNormal).transformDirection(y.worldMatrix))}return o.sort((A,y)=>A.hit.distance-y.hit.distance),o}intersectPlane(t,e=this.origin,i=this.direction){const r=Rt;r.sub(t.origin,e);const n=r.dot(t.normal),a=i.dot(t.normal);if(a==0)return 0;const o=n/a;return o<=0?0:e.add(i.scale(o))}intersectSphere(t,e=this.origin,i=this.direction){const r=Le;r.sub(t.center,e);const n=r.dot(i),a=r.dot(r)-n*n,o=t.radius*t.radius;if(a>o)return 0;const h=Math.sqrt(o-a),l=n-h,c=n+h;return l<0&&c<0?0:l<0?c:l}intersectBox(t,e=this.origin,i=this.direction){let r,n,a,o,h,l;const c=1/i.x,u=1/i.y,d=1/i.z,f=t.min,g=t.max;return r=((c>=0?f.x:g.x)-e.x)*c,n=((c>=0?g.x:f.x)-e.x)*c,a=((u>=0?f.y:g.y)-e.y)*u,o=((u>=0?g.y:f.y)-e.y)*u,r>o||a>n||(a>r&&(r=a),o<n&&(n=o),h=((d>=0?f.z:g.z)-e.z)*d,l=((d>=0?g.z:f.z)-e.z)*d,r>l||h>n)||(h>r&&(r=h),l<n&&(n=l),n<0)?0:r>=0?r:n}intersectTriangle(t,e,i,r=!0,n=this.origin,a=this.direction,o=Se){const h=Ft,l=ze,c=Pe;h.sub(e,t),l.sub(i,t),o.cross(h,l);let u=a.dot(o);if(!u)return 0;let d;if(u>0){if(r)return 0;d=1}else d=-1,u=-u;c.sub(n,t);let f=d*a.dot(l.cross(c,l));if(f<0)return 0;let g=d*a.dot(h.cross(c));if(g<0||f+g>u)return 0;let x=-d*c.dot(o);return x<0?0:x/u}getBarycoord(t,e,i,r,n=Ft){const a=ze,o=Pe,h=Qi;a.sub(r,e),o.sub(i,e),h.sub(t,e);const l=a.dot(a),c=a.dot(o),u=a.dot(h),d=o.dot(o),f=o.dot(h),g=l*d-c*c;if(g===0)return n.set(-2,-1,-1);const x=1/g,p=(d*u-c*f)*x,m=(l*f-c*u)*x;return n.set(1-p-m,m,p)}}const Yt="catmullrom",jt="cubicbezier",as="quadraticbezier",rt=new _,nt=new _,yt=new _,Ne=new _;function Zi(s,t,e=.168,i=.168){if(t<1?rt.sub(s[1],s[0]).scale(e).add(s[0]):rt.sub(s[t+1],s[t-1]).scale(e).add(s[t]),t>s.length-3){const r=s.length-1;nt.sub(s[r-1],s[r]).scale(i).add(s[r])}else nt.sub(s[t],s[t+2]).scale(i).add(s[t+1]);return[rt.clone(),nt.clone()]}function Ie(s,t,e,i){const r=1-s;rt.copy(t).scale(r**2),nt.copy(e).scale(2*r*s),yt.copy(i).scale(s**2);const n=new _;return n.add(rt,nt).add(yt),n}function De(s,t,e,i,r){const n=1-s;rt.copy(t).scale(n**3),nt.copy(e).scale(3*n**2*s),yt.copy(i).scale(3*n*s**2),Ne.copy(r).scale(s**3);const a=new _;return a.add(rt,nt).add(yt).add(Ne),a}class dt{constructor({points:t=[new _(0,0,0),new _(0,1,0),new _(1,1,0),new _(1,0,0)],divisions:e=12,type:i=Yt}={}){this.points=t,this.divisions=e,this.type=i}_getQuadraticBezierPoints(t=this.divisions){const e=[],i=this.points.length;if(i<3)return console.warn("Not enough points provided."),[];const r=this.points[0];let n=this.points[1],a=this.points[2];for(let h=0;h<=t;h++){const l=Ie(h/t,r,n,a);e.push(l)}let o=3;for(;i-o>0;){r.copy(a),n=a.scale(2).sub(n),a=this.points[o];for(let h=1;h<=t;h++){const l=Ie(h/t,r,n,a);e.push(l)}o++}return e}_getCubicBezierPoints(t=this.divisions){const e=[],i=this.points.length;if(i<4)return console.warn("Not enough points provided."),[];let r=this.points[0],n=this.points[1],a=this.points[2],o=this.points[3];for(let l=0;l<=t;l++){const c=De(l/t,r,n,a,o);e.push(c)}let h=4;for(;i-h>1;){r.copy(o),n=o.scale(2).sub(a),a=this.points[h],o=this.points[h+1];for(let l=1;l<=t;l++){const c=De(l/t,r,n,a,o);e.push(c)}h+=2}return e}_getCatmullRomPoints(t=this.divisions,e=.168,i=.168){const r=[];if(this.points.length<=2)return this.points;let a;return this.points.forEach((o,h)=>{if(h===0)a=o;else{const[l,c]=Zi(this.points,h-1,e,i),u=new dt({points:[a,l,c,o],type:jt});r.pop(),r.push(...u.getPoints(t)),a=o}}),r}getPoints(t=this.divisions,e=.168,i=.168){const r=this.type;return r===as?this._getQuadraticBezierPoints(t):r===jt?this._getCubicBezierPoints(t):r===Yt?this._getCatmullRomPoints(t,e,i):this.points}}dt.CATMULLROM=Yt;dt.CUBICBEZIER=jt;dt.QUADRATICBEZIER=as;class Qt{constructor(){this._len=-1,this.tiltStart=0,this.tiltEnd=0}getLength(){return this._len<0&&this.updateLength(),this._len}getTiltAt(t){return this.tiltStart*(1-t)*this.tiltEnd*t}clone(){return new this.constructor().copy(this)}copy(t){return this._len=t._len,this.tiltStart=t.tiltStart,this.tiltEnd=t.tiltEnd,this}}const wt=[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],hs=[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],Ji=s=>s*Math.PI/180,tr=s=>180*s/Math.PI,Lt=(s,t,e)=>Math.max(t,Math.min(s,e));function er(s,t,e,i){const r=t[0],n=t[1],a=t[2],o=1-i;return s[0]=r*r*o+i,s[1]=n*r*o+a*e,s[2]=a*r*o-n*e,s[3]=0,s[4]=r*n*o-a*e,s[5]=n*n*o+i,s[6]=a*n*o+r*e,s[7]=0,s[8]=r*a*o+n*e,s[9]=n*a*o-r*e,s[10]=a*a*o+i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Oe(s,t,e,i=t,r=e){const n=Math.sin(s),a=Math.cos(s),o=a*t.x+n*e.x,h=a*t.y+n*e.y,l=a*t.z+n*e.z,c=a*e.x-n*t.x,u=a*e.y-n*t.y,d=a*e.z-n*t.z;i.set(o,h,l),r.set(c,u,d)}const sr=new _;function St(s,t,e,i,r){const n=1-s;return n*n*n*t+3*n*n*s*e+3*n*s*s*i+s*s*s*r}function zt(s,t,e,i,r){const n=1-s;return 3*n*n*(e-t)+6*n*s*(i-e)+3*s*s*(r-i)}class ir extends Qt{constructor(t,e,i,r,n=0,a=0){super(),this.p0=t,this.p1=e,this.p2=i,this.p3=r,this.tiltStart=n,this.tiltEnd=a,this._len=-1}updateLength(){const e=wt.length;let i=0;for(let r=0,n;r<e;r++)n=.5*wt[r]+.5,i+=hs[r]*this.getDerivativeAt(n,sr).len();this._len=.5*i}getPointAt(t,e=new _){return e.x=St(t,this.p0.x,this.p1.x,this.p2.x,this.p3.x),e.y=St(t,this.p0.y,this.p1.y,this.p2.y,this.p3.y),e.z=St(t,this.p0.z,this.p1.z,this.p2.z,this.p3.z),e}getDerivativeAt(t,e=new _){return e.x=zt(t,this.p0.x,this.p1.x,this.p2.x,this.p3.x),e.y=zt(t,this.p0.y,this.p1.y,this.p2.y,this.p3.y),e.z=zt(t,this.p0.z,this.p1.z,this.p2.z,this.p3.z),e}getTangentAt(t,e=new _){return this.getDerivativeAt(t,e).normalize()}lastPoint(){return this.p3}}const rr=new _;function Pt(s,t,e,i){const r=1-s;return r*r*t+2*r*s*e+s*s*i}function Ct(s,t,e,i){return 2*(1-s)*(e-t)+2*s*(i-e)}class nr extends Qt{constructor(t,e,i,r=0,n=0){super(),this.p0=t,this.p1=e,this.p2=i,this.tiltStart=r,this.tiltEnd=n,this._len=-1}updateLength(){const e=wt.length;let i=0;for(let r=0,n;r<e;r++)n=.5*wt[r]+.5,i+=hs[r]*this.getDerivativeAt(n,rr).len();this._len=.5*i}getPointAt(t,e=new _){return e.x=Pt(t,this.p0.x,this.p1.x,this.p2.x),e.y=Pt(t,this.p0.y,this.p1.y,this.p2.y),e.z=Pt(t,this.p0.z,this.p1.z,this.p2.z),e}getDerivativeAt(t,e=new _){return e.x=Ct(t,this.p0.x,this.p1.x,this.p2.x),e.y=Ct(t,this.p0.y,this.p1.y,this.p2.y),e.z=Ct(t,this.p0.z,this.p1.z,this.p2.z),e}getTangentAt(t,e=new _){return this.getDerivativeAt(t,e).normalize()}lastPoint(){return this.p2}}const ar=new _;class hr extends Qt{constructor(t,e,i=0,r=0){super(),this.p0=t,this.p1=e,this.tiltStart=i,this.tiltEnd=r,this._len=-1}updateLength(){this._len=ar.sub(this.p1,this.p0).len()}getPointAt(t,e=new _){return Ke(e,this.p0,this.p1,t),e}getTangentAt(t,e=new _){return e.sub(this.p1,this.p0).normalize()}lastPoint(){return this.p1}}const st=new _,Be=new V;function or(s,t){if(this[s]==null)throw new Error(t)}class en{constructor(){this._segments=[],this._lengthOffsets=null,this._totalLength=-1,this._lastPoint=null,this._lastTilt=0,this._assertLastPoint=or.bind(this,"_lastPoint","Can`t get previous point of curve. Did you forget moveTo command?"),this.tiltFunction=null}moveTo(t,e=0){this._totalLength=-1,this._lastPoint=t,this._lastTilt=e}bezierCurveTo(t,e,i,r=0){this._assertLastPoint();const n=new ir(this._lastPoint,t,e,i,this._lastTilt,r);return this.addSegment(n),this}quadraticCurveTo(t,e,i=0){this._assertLastPoint();const r=new nr(this._lastPoint,t,e,this._lastTilt,i);return this.addSegment(r),this}lineTo(t,e=0){this._assertLastPoint();const i=new hr(this._lastPoint,t,this._lastTilt,e);return this.addSegment(i),this}addSegment(t){return this._totalLength=-1,this._lastPoint=t.lastPoint(),this._lastTilt=t.tiltEnd,this._segments.push(t),this}getSegments(){return this._segments}updateLength(){const t=this._segments.length;this._lengthOffsets=new Array(t);let e=0;for(let i=0;i<t;i++)this._lengthOffsets[i]=e,e+=this._segments[i].getLength();this._totalLength=e}getLength(){return this._totalLength<0&&this.updateLength(),this._totalLength}findSegmentIndexAtLength(t){const e=this.getLength();if(t<=0)return[0,0];if(t>=e)return[this._segments.length-1,1];let i=0,r=this._lengthOffsets.length-1,n=-1,a;for(;i<=r;)if(a=Math.ceil((i+r)/2),a===0||a===this._lengthOffsets.length-1||t>=this._lengthOffsets[a]&&t<this._lengthOffsets[a+1]){n=a;break}else t<this._lengthOffsets[a]?r=a-1:i=a+1;const h=this._segments[n].getLength(),l=(t-this._lengthOffsets[n])/h;return[n,l]}getPointAtLength(t,e=new _){const[i,r]=this.findSegmentIndexAtLength(t);return this._segments[i].getPointAt(r,e)}getPointAt(t,e=new _){const i=this.getLength();return this.getPointAtLength(t*i,e)}getTangentAtLength(t,e=new _){const[i,r]=this.findSegmentIndexAtLength(t);return this._segments[i].getTangentAt(r,e)}getTangentAt(t,e=new _){const i=this.getLength();return this.getTangentAtLength(t*i,e)}getTiltAtLength(t){const[e,i]=this.findSegmentIndexAtLength(t);return this._segments[e].getTiltAt(i)}getTiltAt(t){const e=this.getLength();return this.getTiltAtLength(t*e)}getPoints(t=64){const e=new Array(t+1);for(let i=0;i<=t;i++)e[i]=this.getPointAt(i/t);return e}computeFrenetFrames(t=64,e=!1){const i=new Array(t+1),r=new Array(t+1),n=this.tiltFunction??(f=>f),a=this.getLength();for(let f=0;f<=t;f++){const[g,x]=this.findSegmentIndexAtLength(a*f/t),p=this._segments[g];i[f]=p.getTangentAt(x),r[f]=n(p.getTiltAt(x),f/t,this)}const o=Math.abs(i[0].x),h=Math.abs(i[0].y),l=Math.abs(i[0].z),c=new _;o<h&&o<l?c.set(1,0,0):h<o&&h<l?c.set(0,1,0):c.set(0,0,1);const u=new Array(t+1),d=new Array(t+1);u[0]=new _,d[0]=new _,st.cross(i[0],c).normalize(),u[0].cross(i[0],st),d[0].cross(i[0],u[0]);for(let f=1;f<i.length;f++){u[f]=u[f-1].clone(),d[f]=new _,st.cross(i[f-1],i[f]);const g=st.len();if(g>Number.EPSILON){st.scale(1/g);const x=Lt(i[f-1].dot(i[f]),-1,1),p=Lt(g,-1,1);er(Be,st,p,x),u[f].applyMatrix4(Be)}d[f].cross(i[f],u[f])}for(let f=0;f<r.length;f++)Oe(Ji(r[f]),u[f],d[f]);if(e===!0){const f=u[u.length-1];let g=Math.acos(Lt(u[0].dot(f),-1,1))/(u.length-1);i[0].dot(st.cross(u[0],f))>0&&(g=-g);for(let x=1;x<u.length-1;x++){const p=g*x;Oe(p,u[x],d[x]),r[x]+=tr(p)}u[u.length-1]=u[0].clone(),d[d.length-1]=d[0].clone()}return{tangents:i,normals:u,binormals:d,tilts:r}}}const pt=new _,it=new _,Nt=new G,gt=new _;class sn extends ${constructor(t,{path:e,radius:i=1,tubularSegments:r=64,radialSegments:n=8,closed:a=!1,attributes:o={}}={}){super(t,o),this.path=e,this.radius=i,this.tubularSegments=r,this.radialSegments=n,this.closed=a,this.frenetFrames=e.computeFrenetFrames(r,a);const h=(r+1)*(n+1),l=r*n*6;this.positions=new Float32Array(h*3),this.normals=new Float32Array(h*3),this.uvs=new Float32Array(h*2),this.indices=h>65536?new Uint32Array(l):new Uint16Array(l),this._generateAttributes(),this._generateIndices(),this.addAttribute("position",{size:3,data:this.positions}),this.addAttribute("normal",{size:3,data:this.normals}),this.addAttribute("uv",{size:2,data:this.uvs}),this.setIndex({data:this.indices})}_generateAttributes(){for(let t=0;t<=this.tubularSegments;t++){let e=t;t===this.tubularSegments&&(e=this.closed?0:this.tubularSegments),this.path.getPointAt(e/this.tubularSegments,gt);const i=this.frenetFrames.normals[e],r=this.frenetFrames.binormals[e];for(let n=0;n<=this.radialSegments;n++){const a=n/this.radialSegments*Math.PI*2,o=Math.sin(a),h=-Math.cos(a),l=t*(this.radialSegments+1)+n;it.x=h*i.x+o*r.x,it.y=h*i.y+o*r.y,it.z=h*i.z+o*r.z,this.normals.set(it,l*3),pt.x=gt.x+this.radius*it.x,pt.y=gt.y+this.radius*it.y,pt.z=gt.z+this.radius*it.z,this.positions.set(pt,l*3),Nt.x=t/this.tubularSegments,Nt.y=n/this.radialSegments,this.uvs.set(Nt,l*2)}}}_generateIndices(){for(let t=1;t<=this.tubularSegments;t++)for(let e=1;e<=this.radialSegments;e++){const i=(this.radialSegments+1)*(t-1)+(e-1),r=(this.radialSegments+1)*t+(e-1),n=(this.radialSegments+1)*t+e,a=(this.radialSegments+1)*(t-1)+e,o=(t-1)*this.radialSegments+(e-1);this.indices.set([i,r,a,r,n,a],o*6)}}}class rn{constructor(t,{width:e,height:i,dpr:r,wrapS:n=t.CLAMP_TO_EDGE,wrapT:a=t.CLAMP_TO_EDGE,minFilter:o=t.LINEAR,magFilter:h=t.LINEAR,geometry:l=new Kt(t),targetOnly:c=null,depth:u=!0}={}){this.gl=t,this.passes=[],this.geometry=l,this.uniform={value:null},this.targetOnly=c,r&&(this.dpr=r),e&&(this.width=e),i&&(this.height=i),r=this.dpr||this.gl.renderer.dpr,this.resolutionWidth=Math.floor(this.width||this.gl.renderer.width*r),this.resolutionHeight=Math.floor(this.height||this.gl.renderer.height*r);let d={dpr:this.dpr,width:this.resolutionWidth,height:this.resolutionHeight,wrapS:n,wrapT:a,minFilter:o,magFilter:h,depth:u};const f=this.fbo={read:new Z(this.gl,d),write:new Z(this.gl,d),swap:()=>{let g=f.read;f.read=f.write,f.write=g}}}addPass({vertex:t=lr,fragment:e=cr,uniforms:i={},textureUniform:r="tMap",enabled:n=!0}={}){i[r]={value:this.fbo.read.texture};const a=new q(this.gl,{vertex:t,fragment:e,uniforms:i}),h={mesh:new W(this.gl,{geometry:this.geometry,program:a}),program:a,uniforms:i,enabled:n,textureUniform:r};return this.passes.push(h),h}resize({width:t,height:e,dpr:i}={}){i&&(this.dpr=i),t&&(this.width=t),e&&(this.height=e),i=this.dpr||this.gl.renderer.dpr,this.resolutionWidth=Math.floor(this.width||this.gl.renderer.width*i),this.resolutionHeight=Math.floor(this.height||this.gl.renderer.height*i),this.fbo.read.setSize(this.resolutionWidth,this.resolutionHeight),this.fbo.write.setSize(this.resolutionWidth,this.resolutionHeight)}render({scene:t,camera:e,texture:i,target:r=null,update:n=!0,sort:a=!0,frustumCull:o=!0,beforePostCallbacks:h}){const l=this.passes.filter(c=>c.enabled);i||(this.gl.renderer.render({scene:t,camera:e,target:l.length||!r&&this.targetOnly?this.fbo.write:r,update:n,sort:a,frustumCull:o}),this.fbo.swap(),h&&h.forEach(c=>c&&c())),l.forEach((c,u)=>{c.mesh.program.uniforms[c.textureUniform].value=!u&&i?i:this.fbo.read.texture,this.gl.renderer.render({scene:c.mesh,target:u===l.length-1&&(r||!this.targetOnly)?r:this.fbo.write,clear:!0}),this.fbo.swap()}),this.uniform.value=this.fbo.read.texture}}const lr=`
    attribute vec2 uv;
    attribute vec2 position;

    varying vec2 vUv;

    void main() {
        vUv = uv;
        gl_Position = vec4(position, 0, 1);
    }
`,cr=`
    precision highp float;

    uniform sampler2D tMap;
    varying vec2 vUv;

    void main() {
        gl_FragColor = texture2D(tMap, vUv);
    }
`,It=new _,Dt=new at,Ot=new _,Ue=new _,ke=new at,Ve=new _;class ur{constructor({objects:t,data:e}){this.objects=t,this.data=e,this.elapsed=0,this.weight=1,this.duration=e.frames.length-1}update(t=1,e){const i=e?1:this.weight/t,r=this.elapsed%this.duration,n=Math.floor(r),a=r-n,o=this.data.frames[n],h=this.data.frames[(n+1)%this.duration];this.objects.forEach((l,c)=>{It.fromArray(o.position,c*3),Dt.fromArray(o.quaternion,c*4),Ot.fromArray(o.scale,c*3),Ue.fromArray(h.position,c*3),ke.fromArray(h.quaternion,c*4),Ve.fromArray(h.scale,c*3),It.lerp(Ue,a),Dt.slerp(ke,a),Ot.lerp(Ve,a),l.position.lerp(It,i),l.quaternion.slerp(Dt,i),l.scale.lerp(Ot,i)})}}const Ge=new V;class nn extends W{constructor(t,{rig:e,geometry:i,program:r,mode:n=t.TRIANGLES}={}){super(t,{geometry:i,program:r,mode:n}),this.createBones(e),this.createBoneTexture(),this.animations=[],Object.assign(this.program.uniforms,{boneTexture:{value:this.boneTexture},boneTextureSize:{value:this.boneTextureSize}})}createBones(t){if(this.root=new ot,this.bones=[],!(!t.bones||!t.bones.length)){for(let e=0;e<t.bones.length;e++){const i=new ot;i.position.fromArray(t.bindPose.position,e*3),i.quaternion.fromArray(t.bindPose.quaternion,e*4),i.scale.fromArray(t.bindPose.scale,e*3),this.bones.push(i)}t.bones.forEach((e,i)=>{if(this.bones[i].name=e.name,e.parent===-1)return this.bones[i].setParent(this.root);this.bones[i].setParent(this.bones[e.parent])}),this.root.updateMatrixWorld(!0),this.bones.forEach(e=>{e.bindInverse=new V(...e.worldMatrix).inverse()})}}createBoneTexture(){if(!this.bones.length)return;const t=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(this.bones.length*4))/Math.LN2)));this.boneMatrices=new Float32Array(t*t*4),this.boneTextureSize=t,this.boneTexture=new H(this.gl,{image:this.boneMatrices,generateMipmaps:!1,type:this.gl.FLOAT,internalFormat:this.gl.renderer.isWebgl2?this.gl.RGBA32F:this.gl.RGBA,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,flipY:!1,width:t})}addAnimation(t){const e=new ur({objects:this.bones,data:t});return this.animations.push(e),e}update(){let t=0;this.animations.forEach(e=>t+=e.weight),this.animations.forEach((e,i)=>{e.update(t,i===0)})}draw({camera:t}={}){this.root.updateMatrixWorld(!0),this.bones.forEach((e,i)=>{Ge.multiply(e.worldMatrix,e.bindInverse),this.boneMatrices.set(Ge,i*16)}),this.boneTexture&&(this.boneTexture.needsUpdate=!0),super.draw({camera:t})}}function an({font:s,text:t,width:e=1/0,align:i="left",size:r=1,letterSpacing:n=0,lineHeight:a=1.4,wordSpacing:o=0,wordBreak:h=!1}){const l=this;let c,u,d,f;const g=/\n/,x=/\s/;p(),m();function p(){c={},s.chars.forEach(y=>c[y.char]=y)}function m(){s.common.lineHeight,d=s.common.base,f=r/d;let w=t.replace(/[ \n]/g,"").length;u={position:new Float32Array(w*4*3),uv:new Float32Array(w*4*2),id:new Float32Array(w*4),index:new Uint16Array(w*6)};for(let b=0;b<w;b++)u.id.set([b,b,b,b],b*4),u.index.set([b*4,b*4+2,b*4+1,b*4+1,b*4+2,b*4+3],b*6);M()}function M(){const y=[];let w=0,b=0,z=0,R=v();function v(){const F={width:0,glyphs:[]};return y.push(F),b=w,z=0,F}let S=100,T=0;for(;w<t.length&&T<S;){T++;const F=t[w];if(!R.width&&x.test(F)){w++,b=w,z=0;continue}if(g.test(F)){w++,R=v();continue}const L=c[F]||c[" "];if(R.glyphs.length){const N=R.glyphs[R.glyphs.length-1][0];let D=A(L.id,N.id)*f;R.width+=D,z+=D}R.glyphs.push([L,R.width]);let C=0;if(x.test(F)?(b=w,z=0,C+=o*r):C+=n*r,C+=L.xadvance*f,R.width+=C,z+=C,R.width>e){if(h&&R.glyphs.length>1){R.width-=C,R.glyphs.pop(),R=v();continue}else if(!h&&z!==R.width){let N=w-b+1;R.glyphs.splice(-N,N),w=b,R.width-=z,R=v();continue}}w++,T=0}R.width||y.pop(),E(y)}function E(y){const w=s.common.scaleW,b=s.common.scaleH;let z=.07*r,R=0;for(let v=0;v<y.length;v++){let S=y[v];for(let T=0;T<S.glyphs.length;T++){const F=S.glyphs[T][0];let L=S.glyphs[T][1];if(i==="center"?L-=S.width*.5:i==="right"&&(L-=S.width),x.test(F.char))continue;L+=F.xoffset*f,z-=F.yoffset*f;let C=F.width*f,N=F.height*f;u.position.set([L,z-N,0,L,z,0,L+C,z-N,0,L+C,z,0],R*4*3);let D=F.x/w,I=F.width/w,B=1-F.y/b,Y=F.height/b;u.uv.set([D,B-Y,D,B,D+I,B-Y,D+I,B],R*4*2),z+=F.yoffset*f,R++}z-=r*a}l.buffers=u,l.numLines=y.length,l.height=l.numLines*r*a,l.width=Math.max(...y.map(v=>v.width))}function A(y,w){for(let b=0;b<s.kernings.length;b++){let z=s.kernings[b];if(!(z.first<y)&&!(z.second<w))return z.first>y||z.first===y&&z.second>w?0:z.amount}return 0}this.resize=function(y){({width:e}=y),M()},this.update=function(y){({text:t}=y),m()}}const fr=`
    precision highp float;
    precision highp int;

    attribute vec3 position;
    attribute vec3 normal;

    uniform mat3 normalMatrix;
    uniform mat4 modelViewMatrix;
    uniform mat4 projectionMatrix;

    varying vec3 vNormal;

    void main() {
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
`,dr=`
    precision highp float;
    precision highp int;

    varying vec3 vNormal;

    void main() {
        gl_FragColor.rgb = normalize(vNormal);
        gl_FragColor.a = 1.0;
    }
`;function pr(s){return new q(s,{vertex:fr,fragment:dr,cullFace:!1})}class hn{constructor(t,{size:e=128,falloff:i=.3,alpha:r=1,dissipation:n=.98,type:a}={}){const o=this;this.gl=t,this.uniform={value:null},this.mask={read:null,write:null,swap:()=>{let c=o.mask.read;o.mask.read=o.mask.write,o.mask.write=c,o.uniform.value=o.mask.read.texture}},h(),this.aspect=1,this.mouse=new G,this.velocity=new G,this.mesh=l();function h(){a||(a=t.HALF_FLOAT||t.renderer.extensions.OES_texture_half_float.HALF_FLOAT_OES);let c=t.renderer.isWebgl2||t.renderer.extensions[`OES_texture_${a===t.FLOAT?"":"half_"}float_linear`]?t.LINEAR:t.NEAREST;const u={width:e,height:e,type:a,format:t.RGBA,internalFormat:t.renderer.isWebgl2?a===t.FLOAT?t.RGBA32F:t.RGBA16F:t.RGBA,minFilter:c,depth:!1};o.mask.read=new Z(t,u),o.mask.write=new Z(t,u),o.mask.swap()}function l(){return new W(t,{geometry:new Kt(t),program:new q(t,{vertex:gr,fragment:mr,uniforms:{tMap:o.uniform,uFalloff:{value:i*.5},uAlpha:{value:r},uDissipation:{value:n},uAspect:{value:1},uMouse:{value:o.mouse},uVelocity:{value:o.velocity}},depthTest:!1})})}}update(){this.mesh.program.uniforms.uAspect.value=this.aspect,this.gl.renderer.render({scene:this.mesh,target:this.mask.write,clear:!1}),this.mask.swap()}}const gr=`
    attribute vec2 uv;
    attribute vec2 position;

    varying vec2 vUv;

    void main() {
        vUv = uv;
        gl_Position = vec4(position, 0, 1);
    }
`,mr=`
    precision highp float;

    uniform sampler2D tMap;

    uniform float uFalloff;
    uniform float uAlpha;
    uniform float uDissipation;
    
    uniform float uAspect;
    uniform vec2 uMouse;
    uniform vec2 uVelocity;

    varying vec2 vUv;

    void main() {
        vec4 color = texture2D(tMap, vUv) * uDissipation;

        vec2 cursor = vUv - uMouse;
        cursor.x *= uAspect;

        vec3 stamp = vec3(uVelocity * vec2(1, -1), 1.0 - pow(1.0 - min(1.0, length(uVelocity)), 3.0));
        float falloff = smoothstep(uFalloff, 0.0, length(cursor)) * uAlpha;

        color.rgb = mix(color.rgb, stamp, vec3(falloff));

        gl_FragColor = color;
    }
`;class on{constructor(t,{data:e=new Float32Array(16),geometry:i=new Kt(t),type:r}){this.gl=t;const n=e;this.passes=[],this.geometry=i,this.dataLength=n.length/4,this.size=Math.pow(2,Math.ceil(Math.log(Math.ceil(Math.sqrt(this.dataLength)))/Math.LN2)),this.coords=new Float32Array(this.dataLength*2);for(let h=0;h<this.dataLength;h++){const l=h%this.size/this.size,c=Math.floor(h/this.size)/this.size;this.coords.set([l,c],h*2)}const a=(()=>{if(n.length===this.size*this.size*4)return n;{const h=new Float32Array(this.size*this.size*4);return h.set(n),h}})();this.uniform={value:new H(t,{image:a,target:t.TEXTURE_2D,type:t.FLOAT,format:t.RGBA,internalFormat:t.renderer.isWebgl2?t.RGBA32F:t.RGBA,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,generateMipmaps:!1,minFilter:t.NEAREST,magFilter:t.NEAREST,width:this.size,flipY:!1})};const o={width:this.size,height:this.size,type:r||t.HALF_FLOAT||t.renderer.extensions.OES_texture_half_float.HALF_FLOAT_OES,format:t.RGBA,internalFormat:t.renderer.isWebgl2?r===t.FLOAT?t.RGBA32F:t.RGBA16F:t.RGBA,minFilter:t.NEAREST,depth:!1,unpackAlignment:1};this.fbo={read:new Z(t,o),write:new Z(t,o),swap:()=>{let h=this.fbo.read;this.fbo.read=this.fbo.write,this.fbo.write=h,this.uniform.value=this.fbo.read.texture}}}addPass({vertex:t=xr,fragment:e=yr,uniforms:i={},textureUniform:r="tMap",enabled:n=!0}={}){i[r]=this.uniform;const a=new q(this.gl,{vertex:t,fragment:e,uniforms:i}),h={mesh:new W(this.gl,{geometry:this.geometry,program:a}),program:a,uniforms:i,enabled:n,textureUniform:r};return this.passes.push(h),h}render(){this.passes.filter(e=>e.enabled).forEach((e,i)=>{this.gl.renderer.render({scene:e.mesh,target:this.fbo.write,clear:!1}),this.fbo.swap()})}}const xr=`
    attribute vec2 uv;
    attribute vec2 position;

    varying vec2 vUv;

    void main() {
        vUv = uv;
        gl_Position = vec4(position, 0, 1);
    }
`,yr=`
    precision highp float;

    uniform sampler2D tMap;
    varying vec2 vUv;

    void main() {
        gl_FragColor = texture2D(tMap, vUv);
    }
`,ht=new _;class ln{constructor(t,{points:e,vertex:i=wr,fragment:r=Er,uniforms:n={},attributes:a={}}){this.gl=t,this.points=e,this.count=e.length,this.position=new Float32Array(this.count*3*2),this.prev=new Float32Array(this.count*3*2),this.next=new Float32Array(this.count*3*2);const o=new Float32Array(this.count*1*2),h=new Float32Array(this.count*2*2),l=new Uint16Array((this.count-1)*3*2);for(let d=0;d<this.count;d++){o.set([-1,1],d*2);const f=d/(this.count-1);if(h.set([0,f,1,f],d*4),d===this.count-1)continue;const g=d*2;l.set([g+0,g+1,g+2],(g+0)*3),l.set([g+2,g+1,g+3],(g+1)*3)}const c=this.geometry=new $(t,Object.assign(a,{position:{size:3,data:this.position},prev:{size:3,data:this.prev},next:{size:3,data:this.next},side:{size:1,data:o},uv:{size:2,data:h},index:{size:1,data:l}}));this.updateGeometry(),n.uResolution||(this.resolution=n.uResolution={value:new G}),n.uDPR||(this.dpr=n.uDPR={value:1}),n.uThickness||(this.thickness=n.uThickness={value:1}),n.uColor||(this.color=n.uColor={value:new ns("#000")}),n.uMiter||(this.miter=n.uMiter={value:1}),this.resize();const u=this.program=new q(t,{vertex:i,fragment:r,uniforms:n});this.mesh=new W(t,{geometry:c,program:u})}updateGeometry(){this.points.forEach((t,e)=>{t.toArray(this.position,e*3*2),t.toArray(this.position,e*3*2+3),e?(t.toArray(this.next,(e-1)*3*2),t.toArray(this.next,(e-1)*3*2+3)):(ht.copy(t).sub(this.points[e+1]).add(t),ht.toArray(this.prev,e*3*2),ht.toArray(this.prev,e*3*2+3)),e===this.points.length-1?(ht.copy(t).sub(this.points[e-1]).add(t),ht.toArray(this.next,e*3*2),ht.toArray(this.next,e*3*2+3)):(t.toArray(this.prev,(e+1)*3*2),t.toArray(this.prev,(e+1)*3*2+3))}),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.prev.needsUpdate=!0,this.geometry.attributes.next.needsUpdate=!0}resize(){this.resolution&&this.resolution.value.set(this.gl.canvas.width,this.gl.canvas.height),this.dpr&&(this.dpr.value=this.gl.renderer.dpr)}}const wr=`
    precision highp float;

    attribute vec3 position;
    attribute vec3 next;
    attribute vec3 prev;
    attribute vec2 uv;
    attribute float side;

    uniform mat4 modelViewMatrix;
    uniform mat4 projectionMatrix;
    uniform vec2 uResolution;
    uniform float uDPR;
    uniform float uThickness;
    uniform float uMiter;

    varying vec2 vUv;

    vec4 getPosition() {
        mat4 mvp = projectionMatrix * modelViewMatrix;
        vec4 current = mvp * vec4(position, 1);
        vec4 nextPos = mvp * vec4(next, 1);
        vec4 prevPos = mvp * vec4(prev, 1);

        vec2 aspect = vec2(uResolution.x / uResolution.y, 1);    
        vec2 currentScreen = current.xy / current.w * aspect;
        vec2 nextScreen = nextPos.xy / nextPos.w * aspect;
        vec2 prevScreen = prevPos.xy / prevPos.w * aspect;
    
        vec2 dir1 = normalize(currentScreen - prevScreen);
        vec2 dir2 = normalize(nextScreen - currentScreen);
        vec2 dir = normalize(dir1 + dir2);
    
        vec2 normal = vec2(-dir.y, dir.x);
        normal /= mix(1.0, max(0.3, dot(normal, vec2(-dir1.y, dir1.x))), uMiter);
        normal /= aspect;

        float pixelWidthRatio = 1.0 / (uResolution.y / uDPR);
        float pixelWidth = current.w * pixelWidthRatio;
        normal *= pixelWidth * uThickness;
        current.xy -= normal * side;
    
        return current;
    }

    void main() {
        vUv = uv;
        gl_Position = getPosition();
    }
`,Er=`
    precision highp float;

    uniform vec3 uColor;
    
    varying vec2 vUv;

    void main() {
        gl_FragColor.rgb = uColor;
        gl_FragColor.a = 1.0;
    }
`;class cn{constructor(t,{light:e=new rs(t),width:i=1024,height:r=i}){this.gl=t,this.light=e,this.target=new Z(t,{width:i,height:r}),this.targetUniform={value:this.target.texture},this.depthProgram=new q(t,{vertex:Bt,fragment:Ut,cullFace:!1}),this.castMeshes=[]}add({mesh:t,receive:e=!0,cast:i=!0,vertex:r=Bt,fragment:n=Ut,uniformProjection:a="shadowProjectionMatrix",uniformView:o="shadowViewMatrix",uniformTexture:h="tShadow"}){if(e&&!t.program.uniforms[a]&&(t.program.uniforms[a]={value:this.light.projectionMatrix},t.program.uniforms[o]={value:this.light.viewMatrix},t.program.uniforms[h]=this.targetUniform),!!i&&(this.castMeshes.push(t),t.colorProgram=t.program,!t.depthProgram)){if(r===Bt&&n===Ut){t.depthProgram=this.depthProgram;return}t.depthProgram=new q(this.gl,{vertex:r,fragment:n,cullFace:!1})}}setSize({width:t=1024,height:e=t}){this.target=new Z(this.gl,{width:t,height:e}),this.targetUniform.value=this.target.texture}render({scene:t}){t.traverse(e=>{e.draw&&(~this.castMeshes.indexOf(e)?e.program=e.depthProgram:(e.isForceVisibility=e.visible,e.visible=!1))}),this.gl.renderer.render({scene:t,camera:this.light,target:this.target}),t.traverse(e=>{e.draw&&(~this.castMeshes.indexOf(e)?e.program=e.colorProgram:e.visible=e.isForceVisibility)})}}const Bt=`
    attribute vec3 position;
    attribute vec2 uv;

    uniform mat4 modelViewMatrix;
    uniform mat4 projectionMatrix;

    void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
`,Ut=`
    precision highp float;

    vec4 packRGBA (float v) {
        vec4 pack = fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * v);
        pack -= pack.yzww * vec2(1.0 / 255.0, 0.0).xxxy;
        return pack;
    }

    void main() {
        gl_FragColor = packRGBA(gl_FragCoord.z);
    }
`;class Mr extends H{constructor(t,{buffer:e,wrapS:i=t.CLAMP_TO_EDGE,wrapT:r=t.CLAMP_TO_EDGE,anisotropy:n=0,minFilter:a,magFilter:o}={}){if(super(t,{generateMipmaps:!1,wrapS:i,wrapT:r,anisotropy:n,minFilter:a,magFilter:o}),e)return this.parseBuffer(e)}parseBuffer(t){const e=new Ar(t);e.mipmaps.isCompressedTexture=!0,this.image=e.mipmaps,this.internalFormat=e.glInternalFormat,e.numberOfMipmapLevels>1?this.minFilter===this.gl.LINEAR&&(this.minFilter=this.gl.NEAREST_MIPMAP_LINEAR):this.minFilter===this.gl.NEAREST_MIPMAP_LINEAR&&(this.minFilter=this.gl.LINEAR)}}function Ar(s){const t=[171,75,84,88,32,49,49,187,13,10,26,10],e=new Uint8Array(s,0,12);for(let u=0;u<e.length;u++)if(e[u]!==t[u])return console.error("File missing KTX identifier");const i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(s,12,13*i),n=r.getUint32(0,!0)===67305985;if(r.getUint32(1*i,n)!==0)return console.warn("only compressed formats currently supported");this.glInternalFormat=r.getUint32(4*i,n);let o=r.getUint32(6*i,n),h=r.getUint32(7*i,n);this.numberOfFaces=r.getUint32(10*i,n),this.numberOfMipmapLevels=Math.max(1,r.getUint32(11*i,n));const l=r.getUint32(12*i,n);this.mipmaps=[];let c=64+l;for(let u=0;u<this.numberOfMipmapLevels;u++){const d=new Int32Array(s,c,1)[0];c+=4;for(let f=0;f<this.numberOfFaces;f++){const g=new Uint8Array(s,c,d);this.mipmaps.push({data:g,width:o,height:h}),c+=d,c+=3-(d+3)%4}o=o>>1,h=h>>1}}let mt={};const lt=[];class un{static load(t,{src:e,wrapS:i=t.CLAMP_TO_EDGE,wrapT:r=t.CLAMP_TO_EDGE,anisotropy:n=0,format:a=t.RGBA,internalFormat:o=a,generateMipmaps:h=!0,minFilter:l=h?t.NEAREST_MIPMAP_LINEAR:t.LINEAR,magFilter:c=t.LINEAR,premultiplyAlpha:u=!1,unpackAlignment:d=4,flipY:f=!0}={}){const g=this.getSupportedExtensions(t);let x="none";if(typeof e=="string"&&(x=e.split(".").pop().split("?")[0].toLowerCase()),typeof e=="object"){for(const M in e)if(g.includes(M.toLowerCase())){x=M.toLowerCase(),e=e[M];break}}const p=e+i+r+n+a+o+h+l+c+u+d+f+t.renderer.id;if(mt[p])return mt[p];let m;switch(x){case"ktx":case"pvrtc":case"s3tc":case"etc":case"etc1":case"astc":m=new Mr(t,{src:e,wrapS:i,wrapT:r,anisotropy:n,minFilter:l,magFilter:c}),m.loaded=this.loadKTX(e,m);break;case"webp":case"jpg":case"jpeg":case"png":m=new H(t,{wrapS:i,wrapT:r,anisotropy:n,format:a,internalFormat:o,generateMipmaps:h,minFilter:l,magFilter:c,premultiplyAlpha:u,unpackAlignment:d,flipY:f}),m.loaded=this.loadImage(t,e,m,f);break;default:console.warn("No supported format supplied"),m=new H(t)}return m.ext=x,mt[p]=m,m}static getSupportedExtensions(t){if(lt.length)return lt;const e={pvrtc:t.renderer.getExtension("WEBGL_compressed_texture_pvrtc")||t.renderer.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),s3tc:t.renderer.getExtension("WEBGL_compressed_texture_s3tc"),etc1:t.renderer.getExtension("WEBGL_compressed_texture_etc1"),astc:t.renderer.getExtension("WEBGL_compressed_texture_astc"),bc7:t.renderer.getExtension("EXT_texture_compression_bptc")};for(const i in e)e[i]&&lt.push(i);return lt.push("png","jpg","webp"),lt}static loadKTX(t,e){return fetch(t).then(i=>i.arrayBuffer()).then(i=>e.parseBuffer(i))}static loadImage(t,e,i,r){return _r(e,r).then(n=>(!t.renderer.isWebgl2&&(!$e(n.width)||!$e(n.height))&&(i.generateMipmaps&&(i.generateMipmaps=!1),i.minFilter===t.NEAREST_MIPMAP_LINEAR&&(i.minFilter=t.LINEAR),i.wrapS===t.REPEAT&&(i.wrapS=i.wrapT=t.CLAMP_TO_EDGE)),i.image=n,i.onUpdate=()=>{n.close&&n.close(),i.onUpdate=null},n))}static clearCache(){mt={}}}function $e(s){return Math.log2(s)%1===0}function _r(s,t){return new Promise((e,i)=>{if(br())fetch(s,{mode:"cors"}).then(r=>r.blob()).then(r=>createImageBitmap(r,{imageOrientation:t?"flipY":"none",premultiplyAlpha:"none"})).then(e).catch(r=>i(r));else{const r=new Image;r.crossOrigin="",r.src=s,r.onerror=({type:n})=>i(`${n}: Loading image`),r.onload=()=>e(r)}})}function br(){if(!navigator.userAgent.toLowerCase().includes("chrome"))return!1;try{createImageBitmap}catch{return!1}return!0}const We=new _,vr=new _,Tr=new _,Rr=new _,Xe=new at,Fr=new at,Lr=new at,Sr=new at;class zr{constructor(t,e=1){this.data=t,this.elapsed=0,this.weight=e,this.loop=!0,this.startTime=t.reduce((i,{times:r})=>Math.min(i,r[0]),1/0),this.endTime=t.reduce((i,{times:r})=>Math.max(i,r[r.length-1]),0),this.duration=this.endTime-this.startTime}update(t=1,e){const i=e?1:this.weight/t,r=this.duration?(this.loop?this.elapsed%this.duration:Math.min(this.elapsed,this.duration-.001))+this.startTime:0;this.data.forEach(({node:n,transform:a,interpolation:o,times:h,values:l})=>{if(!this.duration){let M=We,E=3;a==="quaternion"&&(M=Xe,E=4),M.fromArray(l,0),E===4?n[a].slerp(M,i):n[a].lerp(M,i);return}const c=Math.max(1,h.findIndex(M=>M>r))-1,u=c+1;let d=(r-h[c])/(h[u]-h[c]);o==="STEP"&&(d=0);let f=We,g=vr,x=Tr,p=Rr,m=3;a==="quaternion"&&(f=Xe,g=Fr,x=Lr,p=Sr,m=4),o==="CUBICSPLINE"?(f.fromArray(l,c*m*3+m*1),g.fromArray(l,c*m*3+m*2),x.fromArray(l,u*m*3+m*0),p.fromArray(l,u*m*3+m*1),f=this.cubicSplineInterpolate(d,f,g,x,p),m===4&&f.normalize()):(f.fromArray(l,c*m),p.fromArray(l,u*m),m===4?f.slerp(p,d):f.lerp(p,d)),m===4?n[a].slerp(f,i):n[a].lerp(f,i)})}cubicSplineInterpolate(t,e,i,r,n){const a=t*t,o=a*t,h=3*a-2*o,l=o-a,c=1-h,u=l-a+t;for(let d=0;d<e.length;d++)e[d]=c*e[d]+u*(1-t)*i[d]+h*n[d]+l*t*r[d];return e}}const qe=new V,Pr=new V;class Cr extends W{constructor(t,{skeleton:e,geometry:i,program:r,mode:n=t.TRIANGLES}={}){super(t,{geometry:i,program:r,mode:n}),this.skeleton=e,this.program=r,this.createBoneTexture()}createBoneTexture(){if(!this.skeleton.joints.length)return;const t=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(this.skeleton.joints.length*4))/Math.LN2)));this.boneMatrices=new Float32Array(t*t*4),this.boneTextureSize=t,this.boneTexture=new H(this.gl,{image:this.boneMatrices,generateMipmaps:!1,type:this.gl.FLOAT,internalFormat:this.gl.renderer.isWebgl2?this.gl.RGBA32F:this.gl.RGBA,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,flipY:!1,width:t})}updateUniforms(){this.skeleton.joints.forEach((t,e)=>{qe.multiply(t.worldMatrix,t.bindInverse),this.boneMatrices.set(qe,e*16)}),this.boneTexture.needsUpdate=!0,this.program.uniforms.boneTexture.value=this.boneTexture,this.program.uniforms.boneTextureSize.value=this.boneTextureSize}draw({camera:t}={}){this.program.uniforms.boneTexture||Object.assign(this.program.uniforms,{boneTexture:{value:this.boneTexture},boneTextureSize:{value:this.boneTextureSize}}),this.updateUniforms();const e=this.worldMatrix;this.worldMatrix=Pr,super.draw({camera:t}),this.worldMatrix=e}}class Nr extends W{constructor(...t){super(...t),this.frustumCulled=!1,this.isInstancedMesh=!0}addFrustumCull(){this.instanceTransforms=null,this.instanceLightmapScaleOffset=null,this.totalInstanceCount=0,this.frustumCullFunction=null,this.instanceRenderList=null,this.geometry.attributes.instanceMatrix||console.error(`mesh ${this.name?`"${this.name}" `:""}missing instanceMatrix attribute; unable to frustum cull`);const t=this.geometry.attributes.instanceMatrix.data;this.instanceTransforms=[];for(let e=0,i=0;e<t.length;e+=16,i++){const r=new ot;r.index=i,r.matrix.fromArray(t,e),r.decompose(),this.instanceTransforms.push(r),r.setParent(this.parent)}if(this.totalInstanceCount=this.instanceTransforms.length,this.geometry.attributes.lightmapScaleOffset){const e=this.geometry.attributes.lightmapScaleOffset.data;for(let i=0,r=0;i<e.length;i+=4,r++)this.instanceTransforms[r].lightmapData=new Wi().fromArray(e,i)}this.frustumCullFunction=({camera:e})=>{this.instanceRenderList=[],this.instanceTransforms.forEach(i=>{e.frustumIntersectsMesh(this,i.worldMatrix)&&this.instanceRenderList.push(i)}),this.instanceRenderList.forEach((i,r)=>{i.matrix.toArray(this.geometry.attributes.instanceMatrix.data,r*16),i.lightmapData&&(i.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data,r*4),this.geometry.attributes.lightmapScaleOffset.needsUpdate=!0)}),this.geometry.instancedCount=this.instanceRenderList.length,this.geometry.attributes.instanceMatrix.needsUpdate=!0},this.onBeforeRender(this.frustumCullFunction)}removeFrustumCull(){this.offBeforeRender(this.frustumCullFunction),this.geometry.instancedCount=this.totalInstanceCount,this.instanceTransforms.forEach((t,e)=>{t.matrix.toArray(this.geometry.attributes.instanceMatrix.data,e*16),t.lightmapData&&(t.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data,e*4),this.geometry.attributes.lightmapScaleOffset.needsUpdate=!0)}),this.geometry.attributes.instanceMatrix.needsUpdate=!0}}const Ye={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array,"image/jpeg":Uint8Array,"image/png":Uint8Array,"image/webp":Uint8Array},Ir={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},je={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Dr={translation:"position",rotation:"quaternion",scale:"scale"};class fn{static setDracoManager(t){this.dracoManager=t}static setBasisManager(t){this.basisManager=t}static async load(t,e){const i=e.split("/").slice(0,-1).join("/")+"/",r=await this.parseDesc(e);return this.parse(t,r,i)}static async parse(t,e,i){(e.asset===void 0||e.asset.version[0]<2)&&console.warn("Only GLTF >=2.0 supported. Attempting to parse."),e.extensionsRequired?.includes("KHR_draco_mesh_compression")&&!this.dracoManager&&console.warn("KHR_draco_mesh_compression extension required but no manager supplied. Use .setDracoManager()"),e.extensionsRequired?.includes("KHR_texture_basisu")&&!this.basisManager&&console.warn("KHR_texture_basisu extension required but no manager supplied. Use .setBasisManager()");const r=await this.loadBuffers(e,i);t.renderer.bindVertexArray(null);const n=this.parseBufferViews(t,e,r),a=await this.parseImages(t,e,i,n),o=this.parseTextures(t,e,a),h=this.parseMaterials(t,e,o),l=this.parseSkins(t,e,n),c=await this.parseMeshes(t,e,n,h,l),[u,d]=this.parseNodes(t,e,c,l,a);this.populateSkins(l,u);const f=this.parseAnimations(t,e,u,n),g=this.parseScenes(e,u),x=g[e.scene],p=this.parseLights(t,e,u,g);for(let m=u.length;m>=0;m--)u[m]||u.splice(m,1);return{json:e,buffers:r,bufferViews:n,cameras:d,images:a,textures:o,materials:h,meshes:c,nodes:u,lights:p,animations:f,scenes:g,scene:x}}static parseDesc(t){return fetch(t,{mode:"cors"}).then(e=>e.arrayBuffer()).then(e=>{const i=new TextDecoder;return i.decode(new Uint8Array(e,0,4))==="glTF"?this.unpackGLB(e):JSON.parse(i.decode(e))})}static unpackGLB(t){const e=new Uint32Array(t,0,3);if(e[0]!==1179937895)throw new Error("Invalid glTF asset.");if(e[1]!==2)throw new Error(`Unsupported glTF binary version, "${e[1]}".`);const i=new Uint32Array(t,12,2),r=20,n=i[0];if(i[1]!==1313821514)throw new Error("Unexpected GLB layout.");const a=new TextDecoder().decode(t.slice(r,r+n)),o=JSON.parse(a);if(r+n===t.byteLength)return o;const h=new Uint32Array(t,r+n,2);if(h[1]!==5130562)throw new Error("Unexpected GLB layout.");const l=r+n+8,c=h[0],u=t.slice(l,l+c);return o.buffers[0].binary=u,o}static resolveURI(t,e){return typeof t!="string"||t===""?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}static loadBuffers(t,e){return t.buffers?Promise.all(t.buffers.map(i=>{if(i.binary)return i.binary;const r=this.resolveURI(i.uri,e);return fetch(r,{mode:"cors"}).then(n=>n.arrayBuffer())})):null}static parseBufferViews(t,e,i){if(!e.bufferViews)return null;const r=e.bufferViews;return e.meshes&&e.meshes.forEach(({primitives:n})=>{n.forEach(({attributes:a,indices:o,extensions:h})=>{for(const l in a){const c=e.accessors[a[l]];c.bufferView===void 0&&h&&h.KHR_draco_mesh_compression&&(c.bufferView=h.KHR_draco_mesh_compression.bufferView,r[c.bufferView].isDraco=!0),r[c.bufferView].isAttribute=!0}if(o!==void 0){const l=e.accessors[o];l.bufferView===void 0&&h&&h.KHR_draco_mesh_compression&&(l.bufferView=h.KHR_draco_mesh_compression.bufferView,r[l.bufferView].isDraco=!0),r[l.bufferView].isAttribute=!0,r[l.bufferView].target=t.ELEMENT_ARRAY_BUFFER}})}),e.accessors.forEach(({bufferView:n,componentType:a})=>{n!==void 0&&(r[n].componentType=a)}),e.images&&e.images.forEach(({uri:n,bufferView:a,mimeType:o})=>{a!==void 0&&(r[a].mimeType=o)}),r.forEach(({buffer:n,byteOffset:a=0,byteLength:o,byteStride:h,target:l=t.ARRAY_BUFFER,name:c,extensions:u,extras:d,componentType:f,mimeType:g,isAttribute:x,isDraco:p},m)=>{if(r[m].data=i[n].slice(a,a+o),!x||p)return;const M=t.createBuffer();t.bindBuffer(l,M),t.renderer.state.boundBuffer=M,t.bufferData(l,r[m].data,t.STATIC_DRAW),r[m].buffer=M}),r}static parseImages(t,e,i,r){return e.images?Promise.all(e.images.map(async({uri:n,bufferView:a,mimeType:o,name:h})=>{if(o==="image/ktx2"){const{data:c}=r[a];return await this.basisManager.parseTexture(c)}const l=new Image;if(l.name=h,n)l.src=this.resolveURI(n,i);else if(a!==void 0){const{data:c}=r[a],u=new Blob([c],{type:o});l.src=URL.createObjectURL(u)}return l.ready=new Promise(c=>{l.onload=()=>c()}),l})):null}static parseTextures(t,e,i){return e.textures?e.textures.map(r=>this.createTexture(t,e,i,r)):null}static createTexture(t,e,i,{sampler:r,source:n,name:a,extensions:o,extras:h}){n===void 0&&o&&(o.EXT_texture_webp&&(n=o.EXT_texture_webp.source),o.KHR_texture_basisu&&(n=o.KHR_texture_basisu.source));const l=i[n];if(l.texture)return l.texture;const c={flipY:!1,wrapS:t.REPEAT,wrapT:t.REPEAT},u=r!==void 0?e.samplers[r]:null;if(u&&["magFilter","minFilter","wrapS","wrapT"].forEach(f=>{u[f]&&(c[f]=u[f])}),l.isBasis){c.image=l,c.internalFormat=l.internalFormat,l.isCompressedTexture&&(c.generateMipmaps=!1,l.length>1&&(this.minFilter=t.NEAREST_MIPMAP_LINEAR));const f=new H(t,c);return f.name=a,l.texture=f,f}const d=new H(t,c);return d.name=a,l.texture=d,l.ready.then(()=>{d.image=l}),d}static parseMaterials(t,e,i){return e.materials?e.materials.map(({name:r,extensions:n,extras:a,pbrMetallicRoughness:o={},normalTexture:h,occlusionTexture:l,emissiveTexture:c,emissiveFactor:u=[0,0,0],alphaMode:d="OPAQUE",alphaCutoff:f=.5,doubleSided:g=!1})=>{const{baseColorFactor:x=[1,1,1,1],baseColorTexture:p,metallicFactor:m=1,roughnessFactor:M=1,metallicRoughnessTexture:E}=o;return p&&(p.texture=i[p.index]),h&&(h.texture=i[h.index]),E&&(E.texture=i[E.index]),l&&(l.texture=i[l.index]),c&&(c.texture=i[c.index]),{name:r,extensions:n,extras:a,baseColorFactor:x,baseColorTexture:p,metallicFactor:m,roughnessFactor:M,metallicRoughnessTexture:E,normalTexture:h,occlusionTexture:l,emissiveTexture:c,emissiveFactor:u,alphaMode:d,alphaCutoff:f,doubleSided:g}}):null}static parseSkins(t,e,i){return e.skins?e.skins.map(({inverseBindMatrices:r,skeleton:n,joints:a})=>({inverseBindMatrices:this.parseAccessor(r,e,i),skeleton:n,joints:a})):null}static parseMeshes(t,e,i,r,n){return e.meshes?Promise.all(e.meshes.map(async({primitives:a,weights:o,name:h,extensions:l,extras:c={}},u)=>{let d=0,f=[],g=!1;return e.nodes&&e.nodes.forEach(({mesh:p,skin:m,extras:M})=>{p===u&&(d++,m!==void 0&&f.push(m),M&&M.lightmap_scale_offset&&(g=!0))}),!!f.length?(a=await Promise.all(f.map(async p=>(await this.parsePrimitives(t,a,e,i,r,1,g)).map(({geometry:m,program:M,mode:E})=>{const A=new Cr(t,{skeleton:n[p],geometry:m,program:M,mode:E});return A.name=h,A.extras=c,l&&(A.extensions=l),A.frustumCulled=!1,A}))),a.instanceCount=0,a.numInstances=d):a=(await this.parsePrimitives(t,a,e,i,r,d,g)).map(({geometry:p,program:m,mode:M})=>{const E=p.attributes.instanceMatrix?Nr:W,A=new E(t,{geometry:p,program:m,mode:M});return A.name=h,A.extras=c,l&&(A.extensions=l),A.numInstances=d,A}),{primitives:a,weights:o,name:h}})):null}static parsePrimitives(t,e,i,r,n,a,o){return Promise.all(e.map(async({attributes:h,indices:l,material:c,mode:u=4,targets:d,extensions:f,extras:g})=>{const x=new pr(t);c!==void 0&&(x.gltfMaterial=n[c]);const p=new $(t);if(g&&(p.extras=g),f&&(p.extensions=f),f&&f.KHR_draco_mesh_compression){const m=f.KHR_draco_mesh_compression.bufferView,M=f.KHR_draco_mesh_compression.attributes,E={},A={},y={},w={};for(const R in h){const v=i.accessors[h[R]],S=je[R];E[S]=M[R],A[S]=v.componentType,y[S]=Ye[v.componentType].name,w[S]=v.normalized===!0}const{data:b}=r[m],z=await this.dracoManager.decodeGeometry(b,{attributeIds:E,attributeTypes:y});for(let R=0;R<z.attributes.length;R++){const v=z.attributes[R],S=v.name,T=v.array,F=v.itemSize,L=A[S],C=w[S],N=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,N),t.renderer.state.boundBuffer=N,t.bufferData(t.ARRAY_BUFFER,T,t.STATIC_DRAW),p.addAttribute(S,{data:T,size:F,type:L,normalized:C,buffer:N})}if(z.index){const R=z.index.array,v=z.index.itemSize,S=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,S),t.renderer.state.boundBuffer=S,t.bufferData(t.ELEMENT_ARRAY_BUFFER,R,t.STATIC_DRAW),p.addAttribute("index",{data:R,size:v,type:5125,normalized:!1,buffer:S})}}else{for(const m in h)p.addAttribute(je[m],this.parseAccessor(h[m],i,r));l!==void 0&&p.addAttribute("index",this.parseAccessor(l,i,r))}return a>1&&p.addAttribute("instanceMatrix",{instanced:1,size:16,data:new Float32Array(a*16)}),o&&p.addAttribute("lightmapScaleOffset",{instanced:1,size:4,data:new Float32Array(a*4)}),{geometry:p,program:x,mode:u}}))}static parseAccessor(t,e,i){const{bufferView:r,byteOffset:n=0,componentType:a,normalized:o=!1,count:h,type:l,min:c,max:u,sparse:d}=e.accessors[t],{data:f,buffer:g,byteOffset:x=0,byteStride:p=0,target:m}=i[r],M=Ir[l],E=Ye[a],A=E.BYTES_PER_ELEMENT,y=p/A,w=!!p&&y!==M;let b;if(w){const z=new E(f,n);b=new E(h*M);for(let R=0;R<h;R++){const v=y*R,S=v+M;b.set(z.slice(v,S),R*M)}}else b=new E(f,n,h*M);return{data:b,size:M,type:a,normalized:o,buffer:g,stride:p,offset:n,count:h,min:c,max:u}}static parseNodes(t,e,i,r,n){if(!e.nodes)return null;const a=[],o=e.nodes.map(({camera:h,children:l,skin:c,matrix:u,mesh:d,rotation:f,scale:g,translation:x,weights:p,name:m,extensions:M,extras:E})=>{const A=h!==void 0,y=A?new rs(t):new ot;if(A){const v=e.cameras[h];if(v.type==="perspective"){const{yfov:S,znear:T,zfar:F}=v.perspective;y.perspective({fov:S*(180/Math.PI),near:T,far:F})}else{const{xmag:S,ymag:T,znear:F,zfar:L}=v.orthographic;y.orthographic({near:F,far:L,left:-S,right:S,top:-T,bottom:T})}a.push(y)}m&&(y.name=m),E&&(y.extras=E),M&&(y.extensions=M),E&&E.lightmapTexture!==void 0&&(E.lightmapTexture.texture=this.createTexture(t,e,n,{source:E.lightmapTexture.index})),u?(y.matrix.copy(u),y.decompose()):(f&&y.quaternion.copy(f),g&&y.scale.copy(g),x&&y.position.copy(x),y.updateMatrix());let w=!1,b=!0,z=!1;if(d!==void 0&&(c!==void 0?(i[d].primitives[i[d].primitives.instanceCount].forEach(v=>{E&&Object.assign(v.extras,E),v.setParent(y)}),i[d].primitives.instanceCount++,i[d].primitives.instanceCount===i[d].primitives.numInstances&&(delete i[d].primitives.numInstances,delete i[d].primitives.instanceCount)):i[d].primitives.forEach(v=>{E&&Object.assign(v.extras,E),v.geometry.isInstanced&&(w=!0,v.instanceCount?b=!1:v.instanceCount=0,v.geometry.attributes.instanceMatrix&&(z=!0,y.matrix.toArray(v.geometry.attributes.instanceMatrix.data,v.instanceCount*16)),v.geometry.attributes.lightmapScaleOffset&&v.geometry.attributes.lightmapScaleOffset.data.set(E.lightmap_scale_offset,v.instanceCount*4),v.instanceCount++,v.instanceCount===v.numInstances&&(delete v.numInstances,delete v.instanceCount,v.geometry.attributes.instanceMatrix&&(v.geometry.attributes.instanceMatrix.needsUpdate=!0),v.geometry.attributes.lightmapScaleOffset&&(v.geometry.attributes.lightmapScaleOffset.needsUpdate=!0))),w?b&&v.setParent(y):v.setParent(y)})),z){if(!b)return null;y.matrix.identity(),y.decompose()}return y});return e.nodes.forEach(({children:h=[]},l)=>{h.forEach(c=>{o[c]&&o[c].setParent(o[l])})}),i.forEach(({primitives:h},l)=>{h.forEach((c,u)=>{c.isInstancedMesh&&c.addFrustumCull()})}),[o,a]}static populateSkins(t,e){t&&t.forEach(i=>{i.joints=i.joints.map((r,n)=>{const a=e[r];return a.skin=i,a.bindInverse=new V(...i.inverseBindMatrices.data.slice(n*16,(n+1)*16)),a}),i.skeleton&&(i.skeleton=e[i.skeleton])})}static parseAnimations(t,e,i,r){return e.animations?e.animations.map(({channels:n,samplers:a,name:o},h)=>{const l=n.map(({sampler:c,target:u})=>{const{input:d,interpolation:f="LINEAR",output:g}=a[c],{node:x,path:p}=u,m=i[x],M=Dr[p],E=this.parseAccessor(d,e,r).data,A=this.parseAccessor(g,e,r).data;return m.animations||(m.animations=[]),m.animations.includes(h)||m.animations.push(h),{node:m,transform:M,interpolation:f,times:E,values:A}});return{name:o,animation:new zr(l)}}):null}static parseScenes(t,e){return t.scenes?t.scenes.map(({nodes:i=[],name:r,extensions:n,extras:a})=>{const o=i.reduce((h,l)=>(e[l]&&h.push(e[l]),h),[]);return o.extras=a,o}):null}static parseLights(t,e,i,r){const n={directional:[],point:[],spot:[]};r.forEach(o=>o.forEach(h=>h.updateMatrixWorld()));const a=e.extensions?.KHR_lights_punctual?.lights||[];return i.forEach(o=>{if(!o?.extensions?.KHR_lights_punctual)return;const h=o.extensions.KHR_lights_punctual.light,l=a[h],c={name:l.name||"",color:{value:new _().set(l.color||1)}};switch(l.intensity!==void 0&&c.color.value.multiply(l.intensity),l.type){case"directional":c.direction={value:new _(0,0,1).transformDirection(o.worldMatrix)};break;case"point":c.position={value:new _().applyMatrix4(o.worldMatrix)},c.distance={value:l.range},c.decay={value:2};break;case"spot":Object.assign(c,l);break}n[l.type].push(c)}),n}}let kt=0;class dn{constructor(t){this.onMessage=this.onMessage.bind(this),this.queue=new Map,this.initWorker(t)}initWorker(t){this.worker=new Worker(t),this.worker.onmessage=this.onMessage}onMessage({data:t}){const{id:e,error:i,geometry:r}=t;if(i){console.log(i,e);return}const n=this.queue.get(e);this.queue.delete(e),n(r)}decodeGeometry(t,e){kt++,this.worker.postMessage({id:kt,buffer:t,config:e});let i;const r=new Promise(n=>i=n);return this.queue.set(kt,i),r}}let Vt,Gt=0;class pn{constructor(t,e){Vt||(Vt=this.getSupportedFormat(e)),this.onMessage=this.onMessage.bind(this),this.queue=new Map,this.initWorker(t)}getSupportedFormat(t=document.createElement("canvas").getContext("webgl")){return t.getExtension("WEBGL_compressed_texture_astc")?"astc":t.getExtension("EXT_texture_compression_bptc")?"bptc":t.getExtension("WEBGL_compressed_texture_s3tc")?"s3tc":t.getExtension("WEBGL_compressed_texture_etc1")?"etc1":t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc")?"pvrtc":"none"}initWorker(t){this.worker=new Worker(t),this.worker.onmessage=this.onMessage}onMessage({data:t}){const{id:e,error:i,image:r}=t;if(i){console.log(i,e);return}const n=this.queue.get(e);this.queue.delete(e),r.isBasis=!0,n(r)}parseTexture(t){Gt++,this.worker.postMessage({id:Gt,buffer:t,supportedFormat:Vt});let e;const i=new Promise(r=>e=r);return this.queue.set(Gt,e),i}}class gn extends W{constructor(t,{geometry:e,wireColor:i=new ns(0,.75,.5),...r}={}){const n=new q(t,{vertex:Br,fragment:Ur,uniforms:{wireColor:{value:i}}}),a=e.attributes.position.data,o=[],h=new Set;function l(d){for(let f=0;f<d.length;f+=2)Or(d[f]*3,d[f+1]*3,a,h)&&o.push(d[f],d[f+1])}if(e.attributes.index){const d=e.attributes.index.data;for(let f=0;f<d.length;f+=3)l([d[f],d[f+1],d[f+1],d[f+2],d[f+2],d[f]])}else{const d=Math.floor(a.length/3);for(let f=0;f<d;f+=3)l([f,f+1,f+1,f+2,f+2,f])}const c=o.length>65536?new Uint32Array(o):new Uint16Array(o),u=new $(t,{position:{...e.attributes.position},index:{data:c}});super(t,{...r,mode:t.LINES,geometry:u,program:n})}}function Or(s,t,e,i){const r=[e[s],e[s+1],e[s+2],e[t],e[t+1],e[t+2]].join("#"),n=[e[t],e[t+1],e[t+2],e[s],e[s+1],e[s+2]].join("#"),a=i.size;return i.add(r),i.add(n),i.size-a===2}const Br=`
attribute vec3 position;
uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;

void main() {    
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Ur=`
precision highp float;
uniform vec3 wireColor;

void main() {    
    gl_FragColor = vec4(wireColor, 1.0);
}
`;class mn extends W{constructor(t,{size:e=1,symmetric:i=!1,xColor:r=new _(.96,.21,.32),yColor:n=new _(.44,.64,.11),zColor:a=new _(.18,.52,.89),...o}={}){const h=i?-e:0,l=e,c=new Float32Array([h,0,0,l,0,0,0,h,0,0,l,0,0,0,h,0,0,l]),u=new Float32Array([...r,...r,...n,...n,...a,...a]),d=new $(t,{position:{size:3,data:c},color:{size:3,data:u}}),f=new q(t,{vertex:kr,fragment:Vr});super(t,{...o,mode:t.LINES,geometry:d,program:f})}}const kr=`
attribute vec3 position;
attribute vec3 color;
uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;

varying vec3 vColor;

void main() {    
    vColor = color;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Vr=`
precision highp float;
varying vec3 vColor;

void main() {    
    gl_FragColor = vec4(vColor, 1.0);
}
`;class xn extends W{constructor(t,{size:e=10,divisions:i=10,color:r=new _(.75,.75,.75),...n}={}){const a=(e+1)*2*2,o=new Float32Array(a*3),h=e/2;for(let u=0;u<=i;u++){const f=u/i*e-h;o.set([f,0,-h,f,0,h],u*12),o.set([-h,0,f,h,0,f],u*12+6)}const l=new $(t,{position:{size:3,data:o}}),c=new q(t,{vertex:Gr,fragment:$r,uniforms:{color:{value:r}}});super(t,{...n,mode:t.LINES,geometry:l,program:c})}}const Gr=`
attribute vec3 position;
uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;

void main() {    
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,$r=`
precision highp float;
uniform vec3 color;

void main() {    
    gl_FragColor = vec4(color, 1.0);
}
`;class yn extends W{constructor(t,{size:e=.1,color:i=new _(.86,.16,.86),...r}={}){const n=t.gl,a=t.geometry.attributes.normal.count,o=new Float32Array(a*2*3),h=new Float32Array(a*2*3),l=new Float32Array(a*2),c=t.geometry.attributes.normal.data,u=t.geometry.attributes.position.data,d=new Float32Array([0,e]);for(let x=0;x<a;x++){const p=x*6,m=x*3,M=u.subarray(m,m+3);o.set(M,p),o.set(M,p+3);const E=c.subarray(m,m+3);h.set(E,p),h.set(E,p+3),l.set(d,x*2)}const f=new $(n,{position:{size:3,data:o},normal:{size:3,data:h},size:{size:1,data:l}}),g=new q(n,{vertex:Wr,fragment:Xr,uniforms:{color:{value:i},worldNormalMatrix:{value:new Ht},objectWorldMatrix:{value:t.worldMatrix}}});super(n,{...r,mode:n.LINES,geometry:f,program:g}),this.object=t}draw(t){this.program.uniforms.worldNormalMatrix.value.getNormalMatrix(this.object.worldMatrix),super.draw(t)}}const Wr=`
attribute vec3 position;
attribute vec3 normal;
attribute float size;

uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 objectWorldMatrix;
uniform mat3 worldNormalMatrix;

void main() {
    vec3 n = normalize(worldNormalMatrix * normal) * size;
    vec3 p = (objectWorldMatrix * vec4(position, 1.0)).xyz;
    gl_Position = projectionMatrix * viewMatrix * vec4(p + n, 1.0);
}
`,Xr=`
precision highp float;
uniform vec3 color;

void main() {    
    gl_FragColor = vec4(color, 1.0);
}
`,ct=new _,xt=new _,ut=new _,$t=new _,Wt=new _;class wn extends W{constructor(t,{size:e=.1,color:i=new _(.15,.86,.86),...r}={}){const n=t.gl,a=t.geometry.attributes.position.data,o=new Float32Array([0,e]),h=t.geometry.attributes.index,l=h?m=>h.data[m]:m=>m,c=h?h.data.length:Math.floor(a.length/3),u=Math.floor(c/3),d=new Float32Array(u*2*3),f=new Float32Array(u*2*3),g=new Float32Array(u*2);for(let m=0;m<c;m+=3){ct.fromArray(a,l(m+0)*3),xt.fromArray(a,l(m+1)*3),ut.fromArray(a,l(m+2)*3),$t.add(ct,xt).add(ut).multiply(1/3),ct.sub(ct,xt),ut.sub(ut,xt),Wt.cross(ut,ct).normalize();const M=m*2;d.set($t,M),d.set($t,M+3),f.set(Wt,M),f.set(Wt,M+3),g.set(o,m/3*2)}const x=new $(n,{position:{size:3,data:d},normal:{size:3,data:f},size:{size:1,data:g}}),p=new q(n,{vertex:qr,fragment:Yr,uniforms:{color:{value:i},worldNormalMatrix:{value:new Ht},objectWorldMatrix:{value:t.worldMatrix}}});super(n,{...r,mode:n.LINES,geometry:x,program:p}),this.object=t}draw(t){this.program.uniforms.worldNormalMatrix.value.getNormalMatrix(this.object.worldMatrix),super.draw(t)}}const qr=`
attribute vec3 position;
attribute vec3 normal;
attribute float size;

uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 objectWorldMatrix;
uniform mat3 worldNormalMatrix;

void main() {
    vec3 n = normalize(worldNormalMatrix * normal) * size;
    vec3 p = (objectWorldMatrix * vec4(position, 1.0)).xyz;
    gl_Position = projectionMatrix * viewMatrix * vec4(p + n, 1.0);
}
`,Yr=`
precision highp float;
uniform vec3 color;

void main() {    
    gl_FragColor = vec4(color, 1.0);
}
`;class En extends H{constructor(t,e){super(t,{...e,target:t.TEXTURE_3D,width:e.width?e.width:2,height:e.height?e.height:2});const i=new Image;i.crossOrigin="*",i.src=e.src,i.onload=()=>{let r=document.createElement("canvas");r.width=i.width,r.height=i.height;let n=r.getContext("2d");n.scale(1,-1),n.translate(0,-i.height),n.drawImage(i,0,0);const a=n.getImageData(0,0,i.width,i.height).data;r=null,n=null;let o;switch(this.format){case t.RED:o=1;break;case t.RG:o=2;break;case t.RGB:o=3;break;default:o=4;break}const h=this.width*this.height*this.length*o,l=this.type===t.UNSIGNED_BYTE?new Uint8Array(h):new Float32Array(h);let c=0;for(let u=0;u<this.length;u++)for(let d=0;d<this.height;d++)for(let f=0;f<this.width;f++){let g=u%e.tileCountX*this.width,x=Math.floor(u/e.tileCountX)*(this.width*this.height*e.tileCountX),p=f+g+(d*i.width+x);const m=a[p*4],M=a[p*4+1],E=a[p*4+2],A=a[p*4+3];let y=[m,M,E,A];for(let w=0;w<o;w++)this.type===this.gl.UNSIGNED_BYTE?l[c++]=y[w]:l[c++]=y[w]/255}this.image=l,this.needsUpdate=!0}}}export{ur as Animation,mn as AxesHelper,pn as BasisManager,Hr as Box,rs as Camera,ns as Color,dt as Curve,Qr as Cylinder,dn as DracoManager,ui as Euler,wn as FaceNormalsHelper,hn as Flowmap,zr as GLTFAnimation,fn as GLTFLoader,Cr as GLTFSkin,on as GPGPU,$ as Geometry,xn as GridHelper,Nr as InstancedMesh,Mr as KTXTexture,Ht as Mat3,V as Mat4,W as Mesh,pr as NormalProgram,Jr as Orbit,en as Path,Q as Plane,ln as Polyline,rn as Post,q as Program,at as Quat,tn as Raycast,Z as RenderTarget,jr as Renderer,cn as Shadow,nn as Skin,Kr as Sphere,an as Text,H as Texture,En as Texture3D,un as TextureLoader,Zr as Torus,ot as Transform,Kt as Triangle,sn as Tube,G as Vec2,_ as Vec3,Wi as Vec4,yn as VertexNormalsHelper,gn as WireMesh};
